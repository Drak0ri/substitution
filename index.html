<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Teacher Finder v1.1</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üîç</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #003d82 0%, #0052a3 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background 0.3s ease;
            position: relative;
        }
        .clock-container {
            position: fixed;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 100;
            min-width: 180px;
            text-align: center;
            transition: all 0.3s ease;
        }
        .clock-container h3 {
            color: #003d82;
            font-size: 0.9em;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .clock-time {
            font-size: 2.5em;
            font-weight: 700;
            color: #333;
            font-family: 'Courier New', monospace;
            margin-bottom: 5px;
        }
        .clock-date {
            font-size: 0.9em;
            color: #666;
        }
        body.matrix-mode .clock-container {
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #00ff00;
            box-shadow: 0 0 30px #00ff00;
        }
        body.matrix-mode .clock-container h3 {
            color: #00ff00;
        }
        body.matrix-mode .clock-time {
            color: #00ff00;
            text-shadow: 0 0 10px #00ff00;
        }
        body.matrix-mode .clock-date {
            color: #00ff41;
        }
        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 700px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
            font-size: 2em;
            transition: color 0.3s ease;
        }
        .version-badge {
            background: #28a745;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.4em;
            vertical-align: middle;
            margin-left: 10px;
        }
        .section {
            margin-bottom: 30px;
        }
        .section h2 {
            color: #003d82;
            font-size: 1.3em;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
            transition: all 0.3s ease;
        }
        .input-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            color: #555;
            font-weight: 600;
            margin-bottom: 8px;
            transition: color 0.3s ease;
        }
        input[type="date"],
        input[type="time"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s ease;
        }
        input:focus {
            outline: none;
            border-color: #003d82;
        }
        .time-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        button {
            width: 100%;
            background: linear-gradient(135deg, #003d82 0%, #0052a3 100%);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 10px;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 61, 130, 0.4);
        }
        button:active {
            transform: translateY(0);
        }
        .results {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            min-height: 100px;
            transition: all 0.3s ease;
        }

        /* Available Now Two Column Layout */
        .available-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }

        .available-column {
            background: white;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #e0e0e0;
        }

        .available-header {
            font-size: 0.95em;
            margin: 0 0 10px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid #e0e0e0;
        }

        .available-header.teaching {
            color: #003d82;
        }

        .available-header.admin {
            color: #6c757d;
        }

        .admin-note {
            font-weight: normal;
            font-size: 0.8em;
            opacity: 0.7;
        }

        .column-status {
            font-size: 0.85em;
            color: #666;
            font-style: italic;
            margin-top: 10px;
        }

        .teacher-list.admin-available li {
            background: #6c757d;
        }

        /* Assign Cover Button */
        .assign-cover-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            cursor: pointer;
            margin-left: 8px;
            transition: all 0.2s ease;
            width: auto;
        }

        .assign-cover-btn:hover {
            background: #218838;
            transform: scale(1.05);
        }

        body.matrix-mode .assign-cover-btn {
            background: #00ff00;
            color: #000;
        }

        body.matrix-mode .assign-cover-btn:hover {
            background: #00ff41;
        }

        /* Assign Cover Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .modal-header h3 {
            color: #003d82;
            margin: 0;
            font-size: 1.3em;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: auto;
            line-height: 1;
        }

        .modal-close:hover {
            color: #333;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-body .input-group {
            margin-bottom: 15px;
        }

        .modal-body label {
            display: block;
            color: #555;
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .modal-body input,
        .modal-body textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.2s;
        }

        .modal-body input:focus,
        .modal-body textarea:focus {
            outline: none;
            border-color: #003d82;
        }

        .modal-body textarea {
            min-height: 80px;
            resize: vertical;
        }

        .modal-body .time-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .modal-teacher-name {
            background: #e3f2fd;
            color: #003d82;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-footer button {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            width: auto;
        }

        .modal-btn-cancel {
            background: #f0f0f0;
            color: #666;
            border: none;
        }

        .modal-btn-cancel:hover {
            background: #e0e0e0;
        }

        .modal-btn-save {
            background: #28a745;
            color: white;
            border: none;
        }

        .modal-btn-save:hover {
            background: #218838;
        }

        /* Matrix mode for modal */
        body.matrix-mode .modal-content {
            background: #000;
            border: 2px solid #00ff00;
            box-shadow: 0 0 30px #00ff00;
        }

        body.matrix-mode .modal-header h3 {
            color: #00ff00;
        }

        body.matrix-mode .modal-header {
            border-bottom-color: #00ff00;
        }

        body.matrix-mode .modal-body label {
            color: #00ff00;
        }

        body.matrix-mode .modal-body input,
        body.matrix-mode .modal-body textarea {
            background: rgba(0, 0, 0, 0.5);
            border-color: #00ff00;
            color: #00ff00;
        }

        body.matrix-mode .modal-teacher-name {
            background: rgba(0, 255, 0, 0.2);
            color: #00ff00;
        }

        body.matrix-mode .modal-btn-save {
            background: #00ff00;
            color: #000;
        }

        /* Tab Navigation */
        .tab-navigation {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 15px;
        }

        .tab-btn {
            background: #f0f0f0;
            color: #666;
            border: none;
            padding: 12px 20px;
            border-radius: 10px 10px 0 0;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            width: auto;
        }

        .tab-btn:hover {
            background: #e0e0e0;
            color: #333;
        }

        .tab-btn.active {
            background: #003d82;
            color: white;
        }

        .assignment-count {
            background: #dc3545;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            min-width: 20px;
            text-align: center;
        }

        .tab-btn.active .assignment-count {
            background: white;
            color: #003d82;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Assignments View Styles */
        .section-description {
            color: #666;
            margin-bottom: 20px;
        }

        .assignments-empty {
            text-align: center;
            padding: 60px 20px;
            background: #f8f9fa;
            border-radius: 10px;
            color: #666;
        }

        .empty-icon {
            font-size: 4em;
            margin-bottom: 15px;
        }

        .empty-hint {
            font-size: 0.9em;
            color: #999;
            margin-top: 10px;
        }

        .assignments-table-container {
            overflow-x: auto;
            margin-bottom: 20px;
        }

        .assignments-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .assignments-table th {
            background: #003d82;
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
        }

        .assignments-table td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.95em;
        }

        .assignments-table tr:hover {
            background: #f8f9fa;
        }

        .assignments-table tr:last-child td {
            border-bottom: none;
        }

        .btn-remove {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
            width: auto;
        }

        .btn-remove:hover {
            background: #c82333;
        }

        .assignments-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .assignments-summary {
            font-weight: 600;
            color: #333;
        }

        .assignments-actions {
            display: flex;
            gap: 10px;
        }

        .btn-export {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            width: auto;
        }

        .btn-export:hover {
            background: #218838;
        }

        .btn-clear {
            background: #dc3545;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            width: auto;
        }

        .btn-clear:hover {
            background: #c82333;
        }

        /* Matrix mode for tabs and assignments */
        body.matrix-mode .tab-navigation {
            border-bottom-color: #00ff00;
        }

        body.matrix-mode .tab-btn {
            background: rgba(0, 0, 0, 0.5);
            color: #00ff00;
            border: 1px solid #00ff00;
        }

        body.matrix-mode .tab-btn.active {
            background: #00ff00;
            color: #000;
        }

        body.matrix-mode .assignments-empty {
            background: rgba(0, 0, 0, 0.5);
            color: #00ff00;
        }

        body.matrix-mode .assignments-table {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #00ff00;
        }

        body.matrix-mode .assignments-table th {
            background: #00ff00;
            color: #000;
        }

        body.matrix-mode .assignments-table td {
            color: #00ff00;
            border-bottom-color: #00ff00;
        }

        body.matrix-mode .assignments-footer {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #00ff00;
        }

        body.matrix-mode .assignments-summary {
            color: #00ff00;
        }

        body.matrix-mode .btn-export {
            background: #00ff00;
            color: #000;
        }

        /* Recommended for Cover Section */
        .recommended-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
        }

        .recommended-empty {
            text-align: center;
            color: #666;
            padding: 20px;
        }

        .recommended-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }

        .recommended-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            transition: all 0.2s ease;
        }

        .recommended-card:hover {
            border-color: #003d82;
            box-shadow: 0 4px 12px rgba(0, 61, 130, 0.15);
        }

        .recommended-card.top-pick {
            border-color: #28a745;
            background: #f8fff8;
        }

        .recommended-rank {
            font-size: 0.8em;
            color: #999;
            font-weight: 600;
        }

        .recommended-card.top-pick .recommended-rank {
            color: #28a745;
        }

        .recommended-name {
            font-weight: 700;
            color: #003d82;
            font-size: 1.1em;
        }

        .recommended-hours {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
        }

        .recommended-hours-value {
            font-weight: 600;
            color: #333;
        }

        .recommended-spare {
            color: #28a745;
            font-weight: 600;
        }

        .recommended-spare.warning {
            color: #ffc107;
        }

        .recommended-spare.danger {
            color: #dc3545;
        }

        .recommended-card.other-staff {
            border-color: #17a2b8;
            background: #f0fafc;
        }

        .other-badge {
            background: #17a2b8;
            color: white;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.7em;
            margin-left: 5px;
            vertical-align: middle;
        }

        /* Warning Notice */
        .warning-notice {
            display: flex;
            gap: 15px;
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 20px;
            align-items: flex-start;
        }

        .warning-icon {
            font-size: 1.5em;
            line-height: 1;
        }

        .warning-text {
            color: #856404;
            font-size: 0.95em;
            line-height: 1.5;
        }

        .warning-text strong {
            color: #664d03;
        }

        /* Matrix mode for Recommended and Warning */
        body.matrix-mode .recommended-container {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #00ff00;
        }

        body.matrix-mode .recommended-card {
            background: rgba(0, 0, 0, 0.5);
            border-color: #00ff00;
        }

        body.matrix-mode .recommended-card.top-pick {
            background: rgba(0, 255, 0, 0.1);
        }

        body.matrix-mode .recommended-name {
            color: #00ff00;
        }

        body.matrix-mode .recommended-hours-value {
            color: #00ff00;
        }

        body.matrix-mode .recommended-spare {
            color: #00ff00;
        }

        body.matrix-mode .warning-notice {
            background: rgba(255, 193, 7, 0.2);
            border-color: #00ff00;
        }

        body.matrix-mode .warning-text {
            color: #00ff00;
        }

        body.matrix-mode .warning-text strong {
            color: #00ff00;
        }
        .teacher-list {
            list-style: none;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .teacher-list li {
            background: #003d82;
            color: white;
            padding: 8px 14px;
            border-radius: 20px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }
        .teacher-name {
            font-weight: 600;
        }
        .teacher-duration {
            font-weight: 400;
            font-size: 0.85em;
            opacity: 0.9;
        }
        .teacher-hours {
            background: rgba(255,255,255,0.2);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.8em;
            font-weight: 500;
        }
        .teacher-hours.hours-warning {
            background: #ffc107;
            color: #000;
        }
        .teacher-hours.hours-danger {
            background: #dc3545;
            color: #fff;
        }
        .status {
            color: #666;
            font-style: italic;
            text-align: center;
            transition: color 0.3s ease;
        }
        .status.error {
            color: #dc3545;
            font-weight: 600;
        }
        .legend {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 15px;
            font-size: 0.9em;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        .legend-dot.available {
            background: #003d82;
        }
        .file-input-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px dashed #003d82;
        }
        .file-input-section h2 {
            margin-bottom: 10px;
        }
        input[type="file"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            background: white;
            transition: border 0.3s;
        }
        input[type="file"]:hover {
            border-color: #003d82;
        }
        input[type="file"]:focus {
            outline: none;
            border-color: #003d82;
        }
        .file-help-text {
            margin-top: 10px;
            font-size: 0.9em;
            color: #666;
            font-style: italic;
        }

        /* Toggle Styles */
        .toggle-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .toggle-container {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-size: 0.9em;
            color: #555;
        }
        .toggle-container input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #003d82;
        }
        body.matrix-mode .toggle-container input[type="checkbox"] {
            accent-color: #00ff00;
        }

        /* Teacher List Section */
        .all-teachers-section {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #f0f0f0;
        }

        /* Two Column Staff Layout */
        .staff-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }

        /* Three Column Staff Layout */
        .staff-columns.three-columns {
            grid-template-columns: 1fr 1fr 1fr;
        }

        .staff-column {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
        }

        .column-header {
            font-size: 1em;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e0e0e0;
        }

        .column-header.teaching {
            color: #003d82;
        }

        .column-header.admin {
            color: #6c757d;
        }

        .column-header.other {
            color: #17a2b8;
        }
        
        .all-teachers-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 8px;
            max-height: 250px;
            overflow-y: auto;
            padding: 5px;
        }

        .all-teachers-list.admin-list li {
            background: #6c757d;
        }

        .all-teachers-list.admin-list li:hover {
            background: #5a6268;
        }

        .all-teachers-list.other-list li {
            background: #17a2b8;
        }

        .all-teachers-list.other-list li:hover {
            background: #138496;
        }
        
        .all-teachers-list li {
            background: #003d82;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            font-weight: 500;
            list-style: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }

        .staff-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .staff-hours {
            background: rgba(255,255,255,0.25);
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.75em;
            font-weight: 600;
            white-space: nowrap;
        }

        .staff-hours.hours-warning {
            background: #ffc107;
            color: #000;
        }

        .staff-hours.hours-danger {
            background: #dc3545;
            color: #fff;
        }
        
        .all-teachers-list li:hover {
            background: #0052a3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 61, 130, 0.3);
        }
        
        .all-teachers-list li.active {
            background: #0052a3;
            box-shadow: 0 0 0 3px rgba(0, 61, 130, 0.3);
        }
        
        /* Teacher Schedule Display */
        .teacher-schedule-display {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            border: 2px solid #003d82;
            display: none;
        }
        
        .teacher-schedule-display.active {
            display: block;
        }
        
        .teacher-schedule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .teacher-schedule-header h3 {
            color: #003d82;
            margin: 0;
        }
        
        .schedule-timeline {
            position: relative;
            margin: 20px 0;
        }
        
        .schedule-item {
            position: relative;
            margin: 5px 0;
            padding: 10px;
            border-radius: 5px;
            border-left: 4px solid;
            background: #f8f9fa;
        }
        
        .schedule-item.arbetstid {
            border-left-color: #28a745;
            background: #e8f5e9;
        }
        
        .schedule-item.lesson {
            border-left-color: #dc3545;
            background: #ffeaea;
        }
        
        .schedule-item.non-lesson {
            border-left-color: #ffc107;
            background: #fff8e1;
            opacity: 0.7;
        }
        
        .schedule-time {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .schedule-subject {
            color: #666;
            font-size: 0.9em;
        }
        
        .schedule-group {
            color: #999;
            font-size: 0.85em;
            margin-top: 3px;
        }
        
        /* Weekly Hours Chart */
        .weekly-hours-chart {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .hours-bar-container {
            margin: 15px 0;
        }
        
        .hours-bar-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9em;
            color: #666;
        }
        
        .hours-bar {
            height: 25px;
            background: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            position: relative;
        }
        
        .hours-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #003d82 0%, #0052a3 100%);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.85em;
        }

        /* Hour threshold warning colors */
        .hours-bar-fill.warning {
            background: linear-gradient(90deg, #ffc107 0%, #ffca2c 100%);
        }
        .hours-bar-fill.danger {
            background: linear-gradient(90deg, #dc3545 0%, #e35d6a 100%);
        }

        /* Matrix Mode Styles */
        #matrix-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            display: none;
            pointer-events: none;
        }

        #matrix-canvas.active {
            display: block;
        }

        body.matrix-mode {
            background: #000;
        }

        body.matrix-mode .container {
            background: rgba(0, 0, 0, 0.8);
            color: #00ff00;
            border: 2px solid #00ff00;
            box-shadow: 0 0 30px #00ff00;
        }

        body.matrix-mode h1,
        body.matrix-mode h2,
        body.matrix-mode label {
            color: #00ff00;
            text-shadow: 0 0 10px #00ff00;
        }

        body.matrix-mode .section h2 {
            border-bottom-color: #00ff00;
        }

        body.matrix-mode input {
            background: rgba(0, 0, 0, 0.5);
            color: #00ff00;
            border-color: #00ff00;
        }

        body.matrix-mode input:focus {
            border-color: #00ff41;
            box-shadow: 0 0 10px #00ff00;
        }

        body.matrix-mode button {
            background: #00ff00;
            color: #000;
            border: 2px solid #00ff00;
            font-weight: 700;
        }

        body.matrix-mode button:hover {
            background: #00ff41;
            box-shadow: 0 0 20px #00ff00;
        }

        body.matrix-mode .results {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #00ff00;
        }

        body.matrix-mode .available-column {
            background: rgba(0, 0, 0, 0.5);
            border-color: #00ff00;
        }

        body.matrix-mode .available-header {
            color: #00ff00;
            border-bottom-color: #00ff00;
        }

        body.matrix-mode .teacher-list li {
            background: #00ff00;
            color: #000;
            border: 1px solid #00ff41;
        }


        body.matrix-mode .file-input-section {
            background: rgba(0, 0, 0, 0.5);
            border-color: #00ff00;
        }

        body.matrix-mode input[type="file"] {
            background: rgba(0, 0, 0, 0.5);
            border-color: #00ff00;
            color: #00ff00;
        }

        body.matrix-mode .all-teachers-list li {
            background: #00ff00;
            color: #000;
        }
        
        body.matrix-mode .all-teachers-list li:hover {
            background: #00ff41;
        }

        body.matrix-mode .all-teachers-list.admin-list li {
            background: #00aa00;
        }

        body.matrix-mode .all-teachers-list.admin-list li:hover {
            background: #00cc00;
        }

        body.matrix-mode .all-teachers-list.other-list li {
            background: #008888;
        }

        body.matrix-mode .all-teachers-list.other-list li:hover {
            background: #00aaaa;
        }

        body.matrix-mode .staff-column {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #00ff00;
        }

        body.matrix-mode .column-header {
            color: #00ff00;
            border-bottom-color: #00ff00;
        }
        
        body.matrix-mode .teacher-schedule-display {
            background: rgba(0, 0, 0, 0.8);
            border-color: #00ff00;
            color: #00ff00;
        }
        
        body.matrix-mode .schedule-item {
            background: rgba(0, 0, 0, 0.5);
            border-left-color: #00ff00;
        }
        
        body.matrix-mode .teacher-schedule-header h3 {
            color: #00ff00;
        }

        .matrix-toggle {
            position: fixed;
            left: 20px;
            top: 20px;
            width: 60px;
            height: 60px;
            padding: 0;
            font-size: 24px;
            background: rgba(0, 0, 0, 0.7);
            color: #00ff00;
            border: 3px solid #00ff00;
            border-radius: 50%;
            cursor: pointer;
            z-index: 1000;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.3);
        }

        .matrix-toggle:hover {
            background: #00ff00;
            color: #000;
            box-shadow: 0 0 30px #00ff00;
            transform: scale(1.1);
        }

        .matrix-toggle.active {
            background: #00ff00;
            color: #000;
            box-shadow: 0 0 40px #00ff00;
        }

        /* Matrix Warning Modal */
        .matrix-warning-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .matrix-warning-modal.active {
            display: flex;
        }

        .matrix-warning-content {
            background: #000;
            border: 3px solid #00ff00;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            max-width: 500px;
            box-shadow: 0 0 50px #00ff00;
            animation: pulse 2s infinite;
        }

        .matrix-warning-content h2 {
            color: #00ff00;
            font-size: 2em;
            margin-bottom: 20px;
            text-shadow: 0 0 20px #00ff00;
            font-family: 'Courier New', monospace;
        }

        .matrix-warning-content p {
            color: #00ff41;
            font-size: 1.2em;
            margin-bottom: 30px;
            font-family: 'Courier New', monospace;
        }

        .matrix-warning-button {
            background: #00ff00;
            color: #000;
            border: 2px solid #00ff00;
            padding: 15px 40px;
            font-size: 1.1em;
            font-weight: 700;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Courier New', monospace;
            text-transform: uppercase;
        }

        .matrix-warning-button:hover {
            background: #00ff41;
            box-shadow: 0 0 30px #00ff00;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 50px #00ff00; }
            50% { box-shadow: 0 0 70px #00ff00, 0 0 100px #00ff00; }
            100% { box-shadow: 0 0 50px #00ff00; }
        }

        /* Feedback Button */
        .feedback-button {
            position: fixed;
            right: 20px;
            bottom: 20px;
            background: linear-gradient(135deg, #003d82 0%, #0052a3 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 30px;
            text-decoration: none;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0, 61, 130, 0.4);
            transition: all 0.3s ease;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .feedback-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 61, 130, 0.5);
        }

        .feedback-button::before {
            content: "üí¨";
            font-size: 1.2em;
        }

        body.matrix-mode .feedback-button {
            background: #00ff00;
            color: #000;
            border: 2px solid #00ff00;
            box-shadow: 0 0 20px #00ff00;
        }

        body.matrix-mode .feedback-button:hover {
            background: #00ff41;
            box-shadow: 0 0 30px #00ff00;
        }

        /* ============================================================
           ANALYTICS DASHBOARD STYLES
           ============================================================ */
        
        .analytics-section {
            margin-bottom: 30px;
        }

        .analytics-section-title {
            color: #003d82;
            font-size: 1.2em;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .dashboard-grid.two-col {
            grid-template-columns: repeat(2, 1fr);
        }

        .dashboard-grid.three-col {
            grid-template-columns: repeat(3, 1fr);
        }

        .dashboard-grid.four-col {
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            border: 1px solid #e0e0e0;
            transition: all 0.2s ease;
        }

        .stat-card:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.12);
            transform: translateY(-2px);
        }

        .stat-card.highlight {
            border-left: 4px solid #003d82;
        }

        .stat-card.success {
            border-left: 4px solid #28a745;
            background: #f8fff8;
        }

        .stat-card.warning {
            border-left: 4px solid #ffc107;
            background: #fffef8;
        }

        .stat-card.danger {
            border-left: 4px solid #dc3545;
            background: #fff8f8;
        }

        .stat-card.info {
            border-left: 4px solid #17a2b8;
            background: #f8fcfd;
        }

        .stat-label {
            font-size: 0.85em;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: 700;
            color: #003d82;
            line-height: 1.2;
        }

        .stat-value.success { color: #28a745; }
        .stat-value.warning { color: #e6a700; }
        .stat-value.danger { color: #dc3545; }

        .stat-unit {
            font-size: 0.5em;
            font-weight: 400;
            color: #999;
            margin-left: 4px;
        }

        .stat-subtext {
            font-size: 0.8em;
            color: #999;
            margin-top: 5px;
        }

        .stat-bar {
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
        }

        .stat-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #003d82 0%, #0052a3 100%);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .stat-bar-fill.success { background: linear-gradient(90deg, #28a745 0%, #34ce57 100%); }
        .stat-bar-fill.warning { background: linear-gradient(90deg, #ffc107 0%, #ffca2c 100%); }
        .stat-bar-fill.danger { background: linear-gradient(90deg, #dc3545 0%, #e35d6a 100%); }

        /* Subject/Room Analysis Cards */
        .analysis-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            border: 1px solid #e0e0e0;
        }

        .analysis-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .analysis-card-title {
            font-weight: 700;
            color: #003d82;
            font-size: 1.1em;
        }

        .analysis-card-badge {
            background: #e3f2fd;
            color: #003d82;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .analysis-card-badge.warning {
            background: #fff3cd;
            color: #856404;
        }

        .analysis-card-badge.danger {
            background: #f8d7da;
            color: #721c24;
        }

        .analysis-detail {
            font-size: 0.85em;
            color: #666;
            margin: 5px 0;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .analysis-detail-icon {
            opacity: 0.7;
        }

        /* Risk Alert Cards */
        .risk-alert {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 12px;
            padding: 15px;
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .risk-alert.critical {
            background: #f8d7da;
            border-color: #dc3545;
        }

        .risk-alert-icon {
            font-size: 1.5em;
        }

        .risk-alert-content {
            flex: 1;
        }

        .risk-alert-title {
            font-weight: 700;
            color: #856404;
            margin-bottom: 5px;
        }

        .risk-alert.critical .risk-alert-title {
            color: #721c24;
        }

        .risk-alert-text {
            font-size: 0.9em;
            color: #664d03;
        }

        .risk-alert.critical .risk-alert-text {
            color: #721c24;
        }

        /* Schedule Pattern Styles */
        .schedule-pattern-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
        }

        .day-card {
            background: white;
            border-radius: 10px;
            padding: 12px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            border: 1px solid #e0e0e0;
        }

        .day-card.busiest {
            border: 2px solid #dc3545;
            background: #fff8f8;
        }

        .day-card.quietest {
            border: 2px solid #28a745;
            background: #f8fff8;
        }

        .day-card.selected {
            outline: 3px solid #003d82;
            outline-offset: 2px;
        }

        .day-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .day-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .day-lessons {
            font-size: 1.5em;
            font-weight: 700;
            color: #003d82;
        }

        .day-label {
            font-size: 0.75em;
            color: #999;
        }

        .day-card.busiest .day-lessons { color: #dc3545; }
        .day-card.quietest .day-lessons { color: #28a745; }

        /* Peak Hours Timeline */
        .peak-hours-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .peak-hours-bar {
            display: flex;
            height: 40px;
            border-radius: 8px;
            overflow: hidden;
            background: #f0f0f0;
        }

        .peak-hour-segment {
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.75em;
            font-weight: 600;
            transition: all 0.2s;
        }

        .peak-hour-segment:hover {
            filter: brightness(1.1);
        }

        .peak-hours-legend {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 0.8em;
            color: #666;
        }

        /* Analytics List */
        .analytics-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .analytics-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
        }

        .analytics-list-item:hover {
            background: #f8f9fa;
        }

        .analytics-list-item:last-child {
            border-bottom: none;
        }

        .analytics-list-name {
            font-weight: 500;
            color: #333;
        }

        .analytics-list-value {
            font-weight: 700;
            color: #003d82;
        }

        .analytics-list-value.warning {
            color: #e6a700;
        }

        .analytics-list-value.danger {
            color: #dc3545;
        }

        /* Scrollable Analysis Container */
        .analysis-scroll-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            background: white;
        }

        /* Empty State */
        .analytics-empty {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .analytics-empty-icon {
            font-size: 3em;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        /* Matrix Mode for Analytics */
        body.matrix-mode .stat-card {
            background: rgba(0, 0, 0, 0.5);
            border-color: #00ff00;
        }

        body.matrix-mode .stat-label {
            color: #00ff00;
        }

        body.matrix-mode .stat-value {
            color: #00ff00;
            text-shadow: 0 0 10px #00ff00;
        }

        body.matrix-mode .analysis-card {
            background: rgba(0, 0, 0, 0.5);
            border-color: #00ff00;
        }

        body.matrix-mode .analysis-card-title {
            color: #00ff00;
        }

        body.matrix-mode .day-card {
            background: rgba(0, 0, 0, 0.5);
            border-color: #00ff00;
        }

        body.matrix-mode .day-name,
        body.matrix-mode .day-lessons {
            color: #00ff00;
        }

        body.matrix-mode .analytics-list-item {
            border-color: #00ff00;
        }

        body.matrix-mode .analytics-list-name,
        body.matrix-mode .analytics-list-value {
            color: #00ff00;
        }

        body.matrix-mode .analytics-section-title {
            color: #00ff00;
            border-color: #00ff00;
        }

        /* Clickable stat cards */
        .stat-card.clickable {
            cursor: pointer;
            position: relative;
        }

        .stat-card.clickable:hover {
            border-color: #003d82;
            box-shadow: 0 6px 20px rgba(0, 61, 130, 0.2);
        }

        .stat-card .click-hint {
            display: block;
            font-size: 0.7em;
            color: #999;
            margin-top: 5px;
        }

        .stat-card.clickable:hover .click-hint {
            color: #003d82;
        }

        /* Detail popup */
        .analytics-detail-popup {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-top: 15px;
            border: 2px solid #003d82;
            box-shadow: 0 4px 15px rgba(0, 61, 130, 0.15);
            display: none;
        }

        .analytics-detail-popup.active {
            display: block;
            animation: slideIn 0.2s ease;
        }

        .analytics-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .analytics-detail-title {
            font-weight: 700;
            color: #003d82;
            font-size: 1.1em;
        }

        .analytics-detail-close {
            background: #f0f0f0;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            line-height: 1;
            color: #666;
        }

        .analytics-detail-close:hover {
            background: #e0e0e0;
            color: #333;
        }

        .analytics-detail-list {
            max-height: 250px;
            overflow-y: auto;
        }

        .analytics-detail-item {
            padding: 8px 12px;
            border-radius: 6px;
            margin: 5px 0;
            background: #f8f9fa;
            font-size: 0.95em;
        }

        /* Clickable list items */
        .analytics-list-item.clickable {
            cursor: pointer;
        }

        .analytics-list-item.clickable:hover {
            background: #e3f2fd;
        }

        .analytics-list-item.clickable .analytics-list-name::after {
            content: " üëÜ";
            font-size: 0.8em;
        }

        /* Inline detail for subjects/rooms */
        .analytics-inline-detail {
            background: #e3f2fd;
            padding: 10px 15px;
            margin: 5px 0;
            border-radius: 6px;
            font-size: 0.85em;
            color: #003d82;
            display: none;
        }

        .analytics-inline-detail.active {
            display: block;
        }

        .analytics-inline-detail-label {
            font-weight: 600;
            margin-right: 5px;
        }

        /* Matrix mode for detail popups */
        body.matrix-mode .analytics-detail-popup {
            background: rgba(0, 0, 0, 0.9);
            border-color: #00ff00;
        }

        body.matrix-mode .analytics-detail-title {
            color: #00ff00;
        }

        body.matrix-mode .analytics-detail-item {
            background: rgba(0, 255, 0, 0.1);
            color: #00ff00;
        }

        body.matrix-mode .analytics-inline-detail {
            background: rgba(0, 255, 0, 0.1);
            color: #00ff00;
        }

        /* Data Status Indicator */
        .data-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9em;
        }
        .data-status.loaded {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .data-status.not-loaded {
            background: #fff3e0;
            color: #ef6c00;
        }
        .data-status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        .data-status.loaded .data-status-dot {
            background: #4caf50;
        }
        .data-status.not-loaded .data-status-dot {
            background: #ff9800;
        }

        /* ============================================
           STAFF EXCLUSION FEATURE - CSS STYLES
           ============================================ */

        /* Exclude button on teacher cards */
        .exclude-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 2px 8px;
            border-radius: 50%;
            font-size: 0.9em;
            font-weight: 700;
            cursor: pointer;
            margin-left: 8px;
            transition: all 0.2s ease;
            width: auto;
            line-height: 1;
            min-width: 24px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .exclude-btn:hover {
            background: #c82333;
            transform: scale(1.1);
        }

        /* Re-include button (when showing excluded staff) */
        .reinclude-btn {
            background: #28a745;
            color: white;
        }

        .reinclude-btn:hover {
            background: #218838;
        }

        /* Excluded staff visual indication */
        .teacher-list li.excluded-staff {
            background: #dc3545;
            opacity: 0.7;
        }

        .teacher-list li.excluded-staff .teacher-name::before {
            content: "üö´ ";
        }

        /* Matrix mode for exclude buttons */
        body.matrix-mode .exclude-btn {
            background: #ff0000;
            border: 1px solid #ff0000;
        }

        body.matrix-mode .exclude-btn:hover {
            background: #ff3333;
        }

        body.matrix-mode .reinclude-btn {
            background: #00ff00;
            border: 1px solid #00ff00;
            color: #000;
        }

        /* Exclusion count badge */
        .exclusion-count {
            background: #dc3545;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            min-width: 20px;
            text-align: center;
            margin-left: 10px;
        }

        /* Toggle group for multiple toggles */
        .toggle-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <canvas id="matrix-canvas"></canvas>
    <button class="matrix-toggle" id="matrix-toggle" title="Enter the Matrix">N</button>
    
    <!-- Matrix Warning Modal -->
    <div id="matrix-warning-modal" class="matrix-warning-modal">
        <div class="matrix-warning-content">
            <h2>‚ö†Ô∏è WARNING ‚ö†Ô∏è</h2>
            <p>You have now entered the Matrix?</p>
            <button class="matrix-warning-button" id="matrix-warning-confirm">Continue</button>
        </div>
    </div>

    <!-- Assign Cover Modal -->
    <div id="assign-cover-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìã Assign Cover</h3>
                <button class="modal-close" id="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-teacher-name" id="modal-teacher-name">Teacher Name</div>
                
                <div class="input-group">
                    <label for="cover-date">Date</label>
                    <input type="date" id="cover-date">
                </div>
                
                <div class="time-inputs">
                    <div class="input-group">
                        <label for="cover-time-from">From</label>
                        <input type="time" id="cover-time-from" min="08:00" max="18:00">
                    </div>
                    <div class="input-group">
                        <label for="cover-time-to">To</label>
                        <input type="time" id="cover-time-to" min="08:00" max="18:00">
                    </div>
                </div>
                
                <div class="input-group">
                    <label for="cover-reason">Class / Reason</label>
                    <textarea id="cover-reason" placeholder="e.g., 7A English - Mr Smith absent"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn-cancel" id="modal-cancel">Cancel</button>
                <button class="modal-btn-save" id="modal-save">Save Assignment</button>
            </div>
        </div>
    </div>
    
    <div class="clock-container">
        <h3>Current Time</h3>
        <div class="clock-time" id="clock-time">--:--:--</div>
        <div class="clock-date" id="clock-date">-- -- ----</div>
    </div>
    
    <div class="container">
        <h1>üîç Teacher Finder <span class="version-badge">v1.1</span></h1>
        
        <!-- Feedback Button -->
        <a id="feedback-button" href="#" target="_blank" class="feedback-button" title="Send Feedback">
            Feedback
        </a>

        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-btn active" data-tab="main-view">üè† Main</button>
            <button class="tab-btn" data-tab="analytics-view">üìà Analytics</button>
            <button class="tab-btn" data-tab="cover-assignments-view">üìã Cover Assignments <span class="assignment-count" id="assignment-count-badge">0</span></button>
        </div>

        <!-- Main View Tab -->
        <div id="main-view" class="tab-content active">
        
            <div class="file-input-section">
                <h2>üìÅ Load Schedule File</h2>
                <input type="file" id="schedule-file-input" accept=".txt,.csv">
                <div class="file-help-text">Select your Lessons.txt file (tab-separated format)</div>
                <div id="data-status" class="data-status not-loaded">
                    <span class="data-status-dot"></span>
                    <span id="data-status-text">No data loaded</span>
                </div>
            </div>
            
            <div class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                    <h2 style="margin: 0;">‚úÖ Available Right Now</h2>
                    <div class="toggle-group">
                        <label class="toggle-container">
                            <input type="checkbox" id="lessons-only-toggle">
                            <span>Lessons Only Mode</span>
                        </label>
                        <label class="toggle-container">
                            <input type="checkbox" id="show-excluded-toggle">
                            <span>Show Excluded <span class="exclusion-count" id="exclusion-count-badge">0</span></span>
                        </label>
                    </div>
                </div>
                <div class="results">
                    <div id="status-now" class="status">Please load a schedule file to begin</div>
                    
                    <!-- Two Column Layout for Available Now -->
                    <div class="available-columns">
                        <div class="available-column">
                            <h4 class="available-header teaching">üìö Teaching Staff</h4>
                            <ul id="teachers-now-teaching" class="teacher-list"></ul>
                        <div id="status-teaching" class="column-status"></div>
                    </div>
                    <div class="available-column">
                        <h4 class="available-header admin">üè¢ Admin Staff <span class="admin-note">(for reference)</span></h4>
                        <ul id="teachers-now-admin" class="teacher-list admin-available"></ul>
                        <div id="status-admin" class="column-status"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                <h2 style="margin: 0;">‚≠ê Recommended for Cover</h2>
                <div class="toggle-group">
                    <label class="toggle-container">
                        <input type="checkbox" id="show-all-week-toggle">
                        <span>Show All Week (Planning)</span>
                    </label>
                    <label class="toggle-container">
                        <input type="checkbox" id="include-other-staff-toggle">
                        <span>Include Other Staff</span>
                    </label>
                </div>
            </div>
            <p class="section-description" id="recommended-description">Teaching staff available RIGHT NOW, ranked by lowest scheduled hours</p>
            <div id="recommended-container" class="recommended-container">
                <div id="recommended-empty" class="recommended-empty">
                    <p>Load a schedule file to see recommendations</p>
                </div>
                <div id="recommended-list" class="recommended-list" style="display: none;">
                    <!-- Recommended teachers will be populated here -->
                </div>
            </div>
        </div>

        <div class="section">
            <h2>üîé Check Specific Time</h2>
            <div class="input-group">
                <label for="date-input">Date</label>
                <input type="date" id="date-input">
            </div>
            <div class="time-inputs">
                <div class="input-group">
                    <label for="time-from">From (08:00 - 18:00)</label>
                    <input type="time" id="time-from" min="08:00" max="18:00" step="300">
                </div>
                <div class="input-group">
                    <label for="time-to">To (08:00 - 18:00)</label>
                    <input type="time" id="time-to" min="08:00" max="18:00" step="300">
                </div>
            </div>
            <button id="check-button">Check Availability</button>
            <div class="results" style="display:none;" id="results-container">
                <div id="status-custom" class="status"></div>
                <ul id="teachers-custom" class="teacher-list"></ul>
            </div>
            <div class="legend">
                <div class="legend-item">
                    <span class="legend-dot available"></span>
                    <span>Available</span>
                </div>
            </div>
        </div>

        <div class="section all-teachers-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                <h2 style="margin: 0;">üë©‚Äçüè´ All Staff</h2>
                <label class="toggle-container">
                    <input type="checkbox" id="hide-mother-tongue-toggle" checked>
                    <span>Hide Mother Tongue Teachers</span>
                </label>
            </div>
            <p style="color: #666; margin-bottom: 15px;">Click on a name to view their schedule and weekly hours</p>
            
            <!-- Three Column Layout -->
            <div class="staff-columns three-columns">
                <div class="staff-column">
                    <h3 class="column-header teaching">üìö Teaching Staff</h3>
                    <ul id="teaching-staff-list" class="all-teachers-list"></ul>
                </div>
                <div class="staff-column">
                    <h3 class="column-header other">üìã Other</h3>
                    <ul id="other-staff-list" class="all-teachers-list other-list"></ul>
                </div>
                <div class="staff-column">
                    <h3 class="column-header admin">üè¢ Admin Staff</h3>
                    <ul id="admin-staff-list" class="all-teachers-list admin-list"></ul>
                </div>
            </div>
            
            <div id="teacher-schedule-display" class="teacher-schedule-display">
                <div class="teacher-schedule-header">
                    <h3 id="selected-teacher-name">Select a teacher</h3>
                    <button id="close-schedule" style="background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; width: auto;">Close</button>
                </div>
                <div id="teacher-schedule-content"></div>
                <div id="weekly-hours-chart" class="weekly-hours-chart">
                    <h4 style="color: #003d82; margin-bottom: 15px;">üìä Weekly Teaching Hours</h4>
                    <div id="hours-chart-content"></div>
                </div>
            </div>
        </div>

        </div> <!-- End of main-view -->

        <!-- Analytics View Tab -->
        <div id="analytics-view" class="tab-content">
            <div id="analytics-empty" class="analytics-empty">
                <div class="analytics-empty-icon">üìä</div>
                <p>Load a schedule file to see analytics</p>
            </div>

            <div id="analytics-content" style="display: none;">

                <!-- Analytics Options -->
                <div style="display: flex; justify-content: flex-end; margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                    <label class="toggle-container">
                        <input type="checkbox" id="include-excluded-analytics-toggle">
                        <span>Include Excluded Staff in Analytics <span class="exclusion-count" id="analytics-exclusion-badge">0</span></span>
                    </label>
                </div>

                <!-- Section 1: Capacity Overview -->
                <div class="analytics-section">
                    <h3 class="analytics-section-title">üìä Capacity Overview</h3>
                    <div class="dashboard-grid four-col">
                        <div class="stat-card highlight">
                            <div class="stat-label">Theoretical Capacity</div>
                            <div class="stat-value" id="stat-theoretical">0<span class="stat-unit">hrs/wk</span></div>
                            <div class="stat-subtext" id="stat-theoretical-detail">0 teachers √ó 18h</div>
                        </div>
                        <div class="stat-card highlight">
                            <div class="stat-label">Actual Teaching Hours</div>
                            <div class="stat-value" id="stat-actual">0<span class="stat-unit">hrs/wk</span></div>
                            <div class="stat-subtext">Scheduled lessons</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Capacity Utilization</div>
                            <div class="stat-value" id="stat-utilization">0<span class="stat-unit">%</span></div>
                            <div class="stat-bar">
                                <div class="stat-bar-fill" id="stat-utilization-bar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="stat-card success">
                            <div class="stat-label">Unused Capacity</div>
                            <div class="stat-value success" id="stat-unused">0<span class="stat-unit">hrs/wk</span></div>
                            <div class="stat-subtext">Available to add</div>
                        </div>
                    </div>
                </div>

                <!-- Section 2: Staff Summary -->
                <div class="analytics-section">
                    <h3 class="analytics-section-title">üë• Staff Summary</h3>
                    <div class="dashboard-grid">
                        <div class="stat-card clickable" id="card-teaching-staff" data-category="teaching">
                            <div class="stat-label">Teaching Staff</div>
                            <div class="stat-value" id="stat-teaching-count">0</div>
                            <div class="stat-subtext">With scheduled lessons</div>
                            <span class="click-hint">üëÜ Click to view list</span>
                        </div>
                        <div class="stat-card clickable" id="card-admin-staff" data-category="admin">
                            <div class="stat-label">Admin Staff</div>
                            <div class="stat-value" id="stat-admin-count">0</div>
                            <div class="stat-subtext">Administrative roles</div>
                            <span class="click-hint">üëÜ Click to view list</span>
                        </div>
                        <div class="stat-card clickable" id="card-other-staff" data-category="other">
                            <div class="stat-label">Other Staff</div>
                            <div class="stat-value" id="stat-other-count">0</div>
                            <div class="stat-subtext">Support & specialist</div>
                            <span class="click-hint">üëÜ Click to view list</span>
                        </div>
                        <div class="stat-card highlight">
                            <div class="stat-label">Avg Hours / Teacher</div>
                            <div class="stat-value" id="stat-avg-hours">0<span class="stat-unit">hrs</span></div>
                            <div class="stat-subtext">Per teaching staff</div>
                        </div>
                        <div class="stat-card success clickable" id="card-under-capacity" data-category="under">
                            <div class="stat-label">Under 18 Hours</div>
                            <div class="stat-value success" id="stat-under-capacity">0</div>
                            <div class="stat-subtext">Available for cover</div>
                            <span class="click-hint">üëÜ Click to view list</span>
                        </div>
                        <div class="stat-card warning clickable" id="card-at-capacity" data-category="at-capacity">
                            <div class="stat-label">At Capacity (18h+)</div>
                            <div class="stat-value warning" id="stat-at-capacity">0</div>
                            <div class="stat-subtext">May need support</div>
                            <span class="click-hint">üëÜ Click to view list</span>
                        </div>
                        <div class="stat-card danger clickable" id="card-over-limit" data-category="over-limit">
                            <div class="stat-label">Over Limit (20h+)</div>
                            <div class="stat-value danger" id="stat-over-limit">0</div>
                            <div class="stat-subtext">‚ö†Ô∏è Needs attention</div>
                            <span class="click-hint">üëÜ Click to view list</span>
                        </div>
                    </div>
                    
                    <!-- Detail popup for staff lists -->
                    <div id="staff-detail-popup" class="analytics-detail-popup">
                        <div class="analytics-detail-header">
                            <span class="analytics-detail-title" id="staff-detail-title">Staff List</span>
                            <button class="analytics-detail-close" id="staff-detail-close">&times;</button>
                        </div>
                        <div class="analytics-detail-list" id="staff-detail-list">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                    
                    <!-- Teachers with Most Spare Capacity -->
                    <h4 style="color: #28a745; margin: 20px 0 10px 0;">‚úÖ Most Spare Capacity</h4>
                    <div class="analysis-scroll-container" style="max-height: 200px;">
                        <ul class="analytics-list" id="spare-capacity-list">
                            <!-- Populated by JS -->
                        </ul>
                    </div>
                </div>

                <!-- Section 3: Subject Analysis -->
                <div class="analytics-section">
                    <h3 class="analytics-section-title">üìö Subject Analysis</h3>
                    <div class="dashboard-grid two-col" style="margin-bottom: 15px;">
                        <div class="stat-card">
                            <div class="stat-label">Subjects Taught</div>
                            <div class="stat-value" id="stat-subject-count">0</div>
                            <div class="stat-subtext">Unique subjects</div>
                        </div>
                        <div class="stat-card warning">
                            <div class="stat-label">Single-Teacher Subjects</div>
                            <div class="stat-value warning" id="stat-single-teacher">0</div>
                            <div class="stat-subtext">‚ö†Ô∏è Cover risk</div>
                        </div>
                    </div>
                    
                    <h4 style="color: #003d82; margin: 15px 0 10px 0;">Hours by Subject</h4>
                    <div class="analysis-scroll-container">
                        <ul class="analytics-list" id="subject-hours-list">
                            <!-- Populated by JS -->
                        </ul>
                    </div>
                </div>

                <!-- Section 4: Room Analysis -->
                <div class="analytics-section">
                    <h3 class="analytics-section-title">üè´ Room Analysis</h3>
                    <div class="dashboard-grid three-col" style="margin-bottom: 15px;">
                        <div class="stat-card">
                            <div class="stat-label">Total Rooms</div>
                            <div class="stat-value" id="stat-room-count">0</div>
                            <div class="stat-subtext">In use</div>
                        </div>
                        <div class="stat-card highlight">
                            <div class="stat-label">Busiest Room</div>
                            <div class="stat-value" id="stat-busiest-room" style="font-size: 1.2em;">-</div>
                            <div class="stat-subtext" id="stat-busiest-room-hours">0 hours</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Avg Room Usage</div>
                            <div class="stat-value" id="stat-avg-room">0<span class="stat-unit">hrs</span></div>
                            <div class="stat-subtext">Per room/week</div>
                        </div>
                    </div>
                    
                    <h4 style="color: #003d82; margin: 15px 0 10px 0;">Room Usage</h4>
                    <div class="analysis-scroll-container">
                        <ul class="analytics-list" id="room-usage-list">
                            <!-- Populated by JS -->
                        </ul>
                    </div>
                </div>

                <!-- Section 5: Schedule Patterns -->
                <div class="analytics-section">
                    <h3 class="analytics-section-title">üìÖ Schedule Patterns</h3>
                    <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">Click a day to see its peak hours breakdown</p>
                    <div class="schedule-pattern-grid" id="day-pattern-grid">
                        <!-- Populated by JS -->
                    </div>
                    
                    <h4 style="color: #003d82; margin: 20px 0 10px 0;">‚è∞ Peak Hours <span style="font-weight: normal; font-size: 0.8em; color: #666;" id="peak-hours-label">(all week average)</span></h4>
                    <div class="peak-hours-container">
                        <div class="peak-hours-bar" id="peak-hours-bar">
                            <!-- Populated by JS -->
                        </div>
                        <div class="peak-hours-legend">
                            <span>08:00</span>
                            <span>10:00</span>
                            <span>12:00</span>
                            <span>14:00</span>
                            <span>16:00</span>
                        </div>
                    </div>
                    
                    <h4 style="color: #28a745; margin: 20px 0 10px 0;">üö∂ Students Out of Class <span style="font-weight: normal; font-size: 0.8em; color: #666;">(click a time slot to see which classes)</span></h4>
                    <div class="peak-hours-container">
                        <div class="peak-hours-bar" id="free-periods-bar">
                            <!-- Populated by JS -->
                        </div>
                        <div class="peak-hours-legend">
                            <span>08:00</span>
                            <span>10:00</span>
                            <span>12:00</span>
                            <span>14:00</span>
                            <span>16:00</span>
                        </div>
                        <p style="color: #666; font-size: 0.85em; margin-top: 10px; text-align: center;">
                            <span style="color: #dc3545;">‚ñ†</span> Most students free &nbsp;&nbsp;
                            <span style="color: #28a745;">‚ñ†</span> Fewest students free
                        </p>
                        
                        <!-- Detail popup for free classes -->
                        <div id="free-classes-detail" class="analytics-detail-popup" style="margin-top: 15px;">
                            <div class="analytics-detail-header">
                                <span class="analytics-detail-title" id="free-classes-title">Classes Free</span>
                                <button class="analytics-detail-close" id="free-classes-close">&times;</button>
                            </div>
                            <div class="analytics-detail-list" id="free-classes-list">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section 6: Risk Analysis -->
                <div class="analytics-section">
                    <h3 class="analytics-section-title">‚ö†Ô∏è Risk Analysis</h3>
                    <div id="risk-alerts-container">
                        <!-- Populated by JS -->
                    </div>
                    
                    <h4 style="color: #dc3545; margin: 20px 0 10px 0;">‚ö†Ô∏è Teachers at Capacity (18h+)</h4>
                    <div class="analysis-scroll-container" style="max-height: 200px;">
                        <ul class="analytics-list" id="at-capacity-list">
                            <!-- Populated by JS -->
                        </ul>
                    </div>
                </div>

                <!-- Section 7: Year Group Analysis -->
                <div class="analytics-section">
                    <h3 class="analytics-section-title">üéì Year Group Analysis</h3>
                    <div class="dashboard-grid two-col" style="margin-bottom: 15px;">
                        <div class="stat-card">
                            <div class="stat-label">Year Groups</div>
                            <div class="stat-value" id="stat-yeargroup-count">0</div>
                            <div class="stat-subtext">Active groups</div>
                        </div>
                        <div class="stat-card highlight">
                            <div class="stat-label">Most Lessons</div>
                            <div class="stat-value" id="stat-busiest-group" style="font-size: 1.2em;">-</div>
                            <div class="stat-subtext" id="stat-busiest-group-hours">0 hours</div>
                        </div>
                    </div>
                    
                    <h4 style="color: #003d82; margin: 15px 0 10px 0;">Hours by Year Group <span style="font-weight: normal; font-size: 0.8em; color: #666;">(click to see subject breakdown)</span></h4>
                    <div class="analysis-scroll-container">
                        <ul class="analytics-list" id="yeargroup-hours-list">
                            <!-- Populated by JS -->
                        </ul>
                    </div>
                    
                    <!-- Detail popup for year group breakdown -->
                    <div id="yeargroup-detail-popup" class="analytics-detail-popup">
                        <div class="analytics-detail-header">
                            <span class="analytics-detail-title" id="yeargroup-detail-title">Class Breakdown</span>
                            <button class="analytics-detail-close" id="yeargroup-detail-close">&times;</button>
                        </div>
                        <div class="analytics-detail-list" id="yeargroup-detail-list" style="max-height: 400px;">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Cover Assignments View Tab -->
        <div id="cover-assignments-view" class="tab-content">
            <div class="section">
                <h2>üìã Cover Assignments</h2>
                <p class="section-description">Manage and export your cover assignments</p>
                
                <div class="warning-notice">
                    <div class="warning-icon">‚ö†Ô∏è</div>
                    <div class="warning-text">
                        <strong>Important:</strong> The "Recommended for Cover" list shows scheduled hours only. 
                        It does not yet include covers assigned here. Please check this list before assigning 
                        new covers to avoid giving too many hours to the same person.
                    </div>
                </div>
                
                <div id="assignments-empty" class="assignments-empty">
                    <div class="empty-icon">üì≠</div>
                    <p>No cover assignments yet</p>
                    <p class="empty-hint">Go to the Main tab and click "Assign" on an available teacher</p>
                </div>
                
                <div id="assignments-table-container" class="assignments-table-container" style="display: none;">
                    <table class="assignments-table">
                        <thead>
                            <tr>
                                <th>Teacher</th>
                                <th>Date</th>
                                <th>Time</th>
                                <th>Class / Reason</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="assignments-table-body">
                            <!-- Assignments will be populated here -->
                        </tbody>
                    </table>
                </div>
                
                <div id="assignments-footer" class="assignments-footer" style="display: none;">
                    <div class="assignments-summary">
                        <span id="assignments-total">0 assignments</span>
                    </div>
                    <div class="assignments-actions">
                        <button type="button" id="clear-all-assignments" class="btn-clear">üóëÔ∏è Clear All</button>
                        <button type="button" id="export-csv" class="btn-export">üì• Export CSV</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // ============================================================================
        // CONFIGURATION SECTION - Easy to edit settings
        // ============================================================================
        
        /**
         * TEACHING SUBJECTS WHITELIST
         * --------------------------
         * These are the ONLY subjects that count as actual teaching lessons.
         * Used for: calculating weekly teaching hours, determining who is "busy"
         * 
         * Add or remove subject codes as needed. Use lowercase.
         */
        const TEACHING_SUBJECTS = new Set([
            // Core academic subjects
            'sv', 'sva',           // Swedish, Swedish as Additional Language
            'en',                   // English
            'ma',                   // Mathematics
            
            // Science subjects
            'no', 'bi', 'fy', 'ke', // NO (Science), Biology, Physics, Chemistry
            
            // Social subjects
            'so', 'hi', 'ge', 're', 'sh', // SO (Social Studies), History, Geography, Religion, Samh√§ll
            
            // Languages
            'sp', 'fr', 'ty',       // Spanish, French, German (as foreign language)
            
            // Practical/Creative subjects
            'mu', 'bl', 'sl', 'hkk', 'idh', 'tk',  // Music, Art, Crafts, Home Economics, PE, Tech
            
            // Other
            'it', 'te', 'he', 'ha', 'rel', 'ps'   // IT, Technology, Health, Handicraft, Religion, Psychology
        ]);

        /**
         * HOUR THRESHOLDS FOR WARNINGS
         * ----------------------------
         * Based on collective agreement (avtal) rules.
         * Yellow warning at 18 hours, Red warning at 20 hours
         */
        const HOUR_THRESHOLD_WARNING = 18;  // Yellow warning threshold
        const HOUR_THRESHOLD_DANGER = 20;   // Red warning threshold

        /**
         * ADMIN STAFF LIST
         * -----------------
         * These staff members will:
         * - NOT appear in "Available Right Now" (can't be used for cover)
         * - NOT appear in "Check Specific Time" results
         * - WILL appear in "All Teachers" section (Admin column) so you can view their schedules
         * 
         * Use exact names as they appear in the Lessons.txt file.
         */
        const ADMIN_STAFF = new Set([
            'MrBlunn',
            'MrGavin',
            'MsBooth',
            'MsKosmynina',
            'MsNygren',
            'MsSagvik',
            'MsSorsa',
            'MsParris',
            'MsBertsdotter',
            'MsEAndersson',
            'MrSalarAli',
            'MsNeama',
            'MsGardell',
            'MrSweidan'      // Teaches but can't be used for substitution
        ]);

        /**
         * SUPPORT STAFF LIST
         * ------------------
         * Staff who support in classrooms but are NOT teachers.
         * They cannot be used for cover/substitution.
         * 
         * These staff members will:
         * - NOT appear in "Available Right Now"
         * - NOT appear in "Recommended for Cover"
         * - WILL appear in "All Teachers" section (Other column)
         */
        const SUPPORT_STAFF = new Set([
            'MrForrestel'    // Supports in classroom but not a teacher
        ]);

        /**
         * MANUAL EXCLUSION LIST
         * ---------------------
         * Add teacher names here to COMPLETELY exclude them from everywhere.
         * Use exact names as they appear in the Lessons.txt file.
         * 
         * Use this for: Student assistants, temp staff, people who shouldn't appear at all
         */
        const MANUAL_EXCLUDE_LIST = new Set([
            // Add names here like: 'StudentAssistant1'
        ]);

        /**
         * NON-LESSON KEYWORDS
         * -------------------
         * If a subject contains any of these keywords, it's NOT a teaching lesson.
         * This helps filter out meetings, breaks, and admin time.
         */
        const NON_LESSON_KEYWORDS = [
            'arbetstid',            // Work time (available time)
            'break duty', 'staff break', 'lunch', 'ped lunch',
            'planning time', 'planning',
            'meeting', 'apt meeting', 'all staff meeting', 'slt meeting', 'spec ed meeting',
            'mentortid', 'mentor',  // Mentor time
            'support',              // Support sessions (not actual lessons)
            'hoy time', 'hod time', // Head of Year/Department time
            'duty', 'rec room duty',
            'admin', 'prep',
            'tutorial'
        ];

        /**
         * INTERNAL CONFIGURATION
         * ----------------------
         * Don't modify unless you know what you're doing!
         */
        const ARBETSTID_SUBJECT = "arbetstid";
        const dayMap = ["Sun", "Mon", "Tue", "Wed", "Thur", "Fri", "Sat"];
        const FEEDBACK_FORM_URL = "YOUR_GOOGLE_FORM_LINK_HERE";

        // ============================================================================
        // APPLICATION STATE
        // ============================================================================
        
        let lessons = [];
        let columnMap = {};
        let lessonsOnlyMode = false;
        let showMotherTongueTeachers = false; // Default: hide them (checkbox is checked)
        let motherTongueTeachersCache = null; // Cache for detected MT teachers
        
        // Cover Assignments
        let coverAssignments = []; // Array to store cover assignments
        let currentModalTeacher = null; // Currently selected teacher for modal
        
        // Recommended for Cover mode
        let showAllWeekRecommendations = false; // Default: show only available now
        let includeOtherStaffInRecommendations = false; // Default: teaching staff only

        // Staff Exclusion Feature
        let excludedStaff = new Set(); // Set of excluded teacher names
        let showExcludedMode = false;  // Whether we're showing excluded staff
        let includeExcludedInAnalytics = false; // Whether to include excluded staff in analytics

        // ============================================================================
        // DOM ELEMENTS
        // ============================================================================
        
        const statusNow = document.getElementById('status-now');
        const statusCustom = document.getElementById('status-custom');
        const teachersCustomList = document.getElementById('teachers-custom');
        const resultsContainer = document.getElementById('results-container');
        const checkButton = document.getElementById('check-button');
        const dateInput = document.getElementById('date-input');
        const timeFromInput = document.getElementById('time-from');
        const timeToInput = document.getElementById('time-to');
        const clockTime = document.getElementById('clock-time');
        const clockDate = document.getElementById('clock-date');
        const lessonsOnlyToggle = document.getElementById('lessons-only-toggle');
        const hideMotherTongueToggle = document.getElementById('hide-mother-tongue-toggle');
        const dataStatusEl = document.getElementById('data-status');
        const dataStatusText = document.getElementById('data-status-text');

        // ============================================================================
        // STAFF EXCLUSION FUNCTIONS
        // ============================================================================

        /**
         * Load excluded staff from localStorage on page load
         */
        function loadExcludedStaff() {
            try {
                const saved = localStorage.getItem('teacherFinder_excludedStaff');
                if (saved) {
                    excludedStaff = new Set(JSON.parse(saved));
                    console.log('[EXCLUSION] Loaded excluded staff:', Array.from(excludedStaff));
                }
            } catch (error) {
                console.error('[EXCLUSION] Error loading excluded staff:', error);
                excludedStaff = new Set();
            }
            updateExclusionBadge();
        }

        /**
         * Save excluded staff to localStorage
         */
        function saveExcludedStaff() {
            try {
                localStorage.setItem('teacherFinder_excludedStaff', JSON.stringify(Array.from(excludedStaff)));
                console.log('[EXCLUSION] Saved excluded staff:', Array.from(excludedStaff));
            } catch (error) {
                console.error('[EXCLUSION] Error saving excluded staff:', error);
            }
        }

        /**
         * Toggle a teacher's exclusion status
         */
        function toggleTeacherExclusion(teacherName) {
            if (excludedStaff.has(teacherName)) {
                excludedStaff.delete(teacherName);
                console.log('[EXCLUSION] Re-included:', teacherName);
            } else {
                excludedStaff.add(teacherName);
                console.log('[EXCLUSION] Excluded:', teacherName);
            }
            saveExcludedStaff();
            updateExclusionBadge();

            // Refresh displays
            updateAvailableNow();
            updateRecommendedForCover();
        }

        /**
         * Update the exclusion count badge
         */
        function updateExclusionBadge() {
            const badge = document.getElementById('exclusion-count-badge');
            if (badge) {
                badge.textContent = excludedStaff.size;
            }
            // Also update analytics badge
            updateAnalyticsExclusionBadge();
        }

        /**
         * Check if a teacher should be filtered out based on exclusion settings
         */
        function shouldFilterExcluded(teacherName) {
            const isExcluded = excludedStaff.has(teacherName);

            if (showExcludedMode) {
                // In "Show Excluded" mode, ONLY show excluded staff
                return !isExcluded;
            } else {
                // In normal mode, hide excluded staff
                return isExcluded;
            }
        }

        /**
         * Check if a teacher should be filtered out from analytics
         * Respects the "Include Excluded in Analytics" toggle
         */
        function shouldFilterExcludedFromAnalytics(teacherName) {
            if (includeExcludedInAnalytics) {
                // Include all staff in analytics
                return false;
            }
            // Otherwise, filter out excluded staff
            return excludedStaff.has(teacherName);
        }

        /**
         * Update the analytics exclusion badge
         */
        function updateAnalyticsExclusionBadge() {
            const badge = document.getElementById('analytics-exclusion-badge');
            if (badge) {
                badge.textContent = excludedStaff.size;
            }
        }

        // ============================================================================
        // CLOCK FUNCTIONALITY
        // ============================================================================

        function updateClock() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            clockTime.textContent = `${hours}:${minutes}:${seconds}`;
            
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            const dayName = days[now.getDay()];
            const monthName = months[now.getMonth()];
            const day = now.getDate();
            const year = now.getFullYear();
            clockDate.textContent = `${dayName}, ${monthName} ${day}, ${year}`;
            
            // Update availability every minute (when seconds = 0)
            if (now.getSeconds() === 0 && lessons.length > 0) {
                updateAvailableNow();
            }
        }

        updateClock();
        setInterval(updateClock, 1000);

        // ============================================================================
        // TIME VALIDATION
        // ============================================================================

        function validateTime(timeStr) {
            if (!timeStr) return false;
            const [hours, minutes] = timeStr.split(':').map(Number);
            const totalMinutes = hours * 60 + minutes;
            return totalMinutes >= 480 && totalMinutes <= 1080; // 08:00 = 480 min, 18:00 = 1080 min
        }

        function clampTimeToRange(timeStr) {
            if (!timeStr) return '08:00';
            const [hours, minutes] = timeStr.split(':').map(Number);
            const totalMinutes = hours * 60 + minutes;
            if (totalMinutes < 480) return '08:00';
            if (totalMinutes > 1080) return '18:00';
            return timeStr;
        }

        timeFromInput.setAttribute('min', '08:00');
        timeFromInput.setAttribute('max', '18:00');
        timeToInput.setAttribute('min', '08:00');
        timeToInput.setAttribute('max', '18:00');

        timeFromInput.addEventListener('change', function() {
            if (!validateTime(this.value)) {
                this.value = clampTimeToRange(this.value);
            }
        });

        timeToInput.addEventListener('change', function() {
            if (!validateTime(this.value)) {
                this.value = clampTimeToRange(this.value);
            }
        });

        // ============================================================================
        // HELPER FUNCTIONS
        // ============================================================================

        function timeToMinutes(timeStr) {
            if (!timeStr) return 0;
            timeStr = timeStr.replace(':', '');
            if (timeStr.length < 4) timeStr = '0' + timeStr;
            const hours = parseInt(timeStr.substring(0, 2), 10);
            const minutes = parseInt(timeStr.substring(2, 4), 10);
            return (isNaN(hours) || isNaN(minutes)) ? 0 : (hours * 60) + minutes;
        }

        function minutesToHHMM(totalMinutes) {
            if (isNaN(totalMinutes)) return "00:00";
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
        }

        function parseRealWeeks(weekString) {
            const weeks = new Set();
            if (!weekString) return weeks;
            weekString.split(',').forEach(range => {
                const parts = range.trim().split('-');
                if (parts.length === 1 && parts[0]) {
                    const weekNum = parseInt(parts[0], 10);
                    if (!isNaN(weekNum)) weeks.add(weekNum);
                } else if (parts.length === 2 && parts[0] && parts[1]) {
                    const start = parseInt(parts[0], 10);
                    const end = parseInt(parts[1], 10);
                    if (!isNaN(start) && !isNaN(end)) {
                        for (let i = start; i <= end; i++) {
                            weeks.add(i);
                        }
                    }
                }
            });
            return weeks;
        }

        function parseTeachers(teacherString) {
            if (!teacherString || typeof teacherString !== 'string') return [];
            return teacherString.split(',').map(t => t.trim()).filter(t => t && t.length > 0);
        }

        function getCalendarWeek(date) {
            const target = new Date(date.valueOf());
            const dayNr = (date.getDay() + 6) % 7;
            target.setDate(target.getDate() - dayNr + 3);
            const firstThursday = target.valueOf();
            target.setMonth(0, 1);
            if (target.getDay() !== 4) {
                target.setMonth(0, 1 + ((4 - target.getDay()) + 7) % 7);
            }
            return 1 + Math.ceil((firstThursday - target) / 604800000);
        }

        // ============================================================================
        // MOTHER TONGUE TEACHER DETECTION
        // ============================================================================

        /**
         * Builds a Set of all teachers who teach Mother Tongue subjects.
         * This is cached after first call for performance.
         */
        function detectMotherTongueTeachers() {
            if (motherTongueTeachersCache !== null) {
                return motherTongueTeachersCache;
            }

            const mtTeachers = new Set();
            
            lessons.forEach(lesson => {
                const subject = (lesson[columnMap['subject']] || '').toLowerCase().trim();
                const teacherStr = lesson[columnMap['teacher']]?.trim();
                
                // Check if this is a Mother Tongue subject
                if (subject.includes('mother tongue') || subject.startsWith('mt ')) {
                    if (teacherStr) {
                        const teachers = parseTeachers(teacherStr);
                        teachers.forEach(t => mtTeachers.add(t));
                    }
                }
            });

            motherTongueTeachersCache = mtTeachers;
            console.log('[CONFIG] Detected Mother Tongue teachers:', Array.from(mtTeachers));
            return mtTeachers;
        }

        /**
         * Checks if a teacher should be excluded from AVAILABILITY lists.
         * Returns true if teacher should be EXCLUDED from Available Now / Check Specific Time.
         * 
         * Note: Admin staff and Support staff are excluded from availability but still shown in All Teachers.
         */
        function shouldExcludeFromAvailability(teacherName) {
            // Check manual exclusion list (completely hidden)
            if (MANUAL_EXCLUDE_LIST.has(teacherName)) {
                return true;
            }

            // Check user-excluded staff (unless we're in "Show Excluded" mode)
            if (shouldFilterExcluded(teacherName)) {
                return true;
            }

            // Check admin staff (hidden from availability only)
            if (ADMIN_STAFF.has(teacherName)) {
                return true;
            }

            // Check support staff (hidden from availability - can't substitute)
            if (SUPPORT_STAFF.has(teacherName)) {
                return true;
            }

            // Check if hiding Mother Tongue teachers and this is one
            if (!showMotherTongueTeachers) {
                const mtTeachers = detectMotherTongueTeachers();
                if (mtTeachers.has(teacherName)) {
                    return true;
                }
            }

            return false;
        }

        /**
         * Checks if a teacher should be completely excluded from everywhere.
         * Used for the All Teachers list.
         */
        function shouldExcludeCompletely(teacherName) {
            // Check manual exclusion list
            if (MANUAL_EXCLUDE_LIST.has(teacherName)) {
                return true;
            }

            // Check if hiding Mother Tongue teachers and this is one
            if (!showMotherTongueTeachers) {
                const mtTeachers = detectMotherTongueTeachers();
                if (mtTeachers.has(teacherName)) {
                    return true;
                }
            }

            return false;
        }

        /**
         * Checks if a teacher is admin staff.
         */
        function isAdminStaff(teacherName) {
            return ADMIN_STAFF.has(teacherName);
        }

        /**
         * Checks if a teacher is support staff.
         * Support staff help in classrooms but cannot be used for substitution.
         */
        function isSupportStaff(teacherName) {
            return SUPPORT_STAFF.has(teacherName);
        }

        // ============================================================================
        // LESSON CLASSIFICATION
        // ============================================================================

        /**
         * Determines if a lesson entry is an actual TEACHING lesson.
         * This is used for calculating teaching hours.
         * 
         * Returns true ONLY for real classroom teaching sessions.
         */
        function isTeachingLesson(lesson) {
            const subject = (lesson[columnMap['subject']] || '').trim().toLowerCase();
            const group = (lesson[columnMap['group']] || '').trim();
            
            // First: Check if subject contains any non-lesson keywords
            for (const keyword of NON_LESSON_KEYWORDS) {
                if (subject.includes(keyword)) {
                    return false;
                }
            }

            // Second: Check if subject matches our teaching subjects whitelist
            // We check if the subject STARTS with any of our teaching codes
            for (const teachingSubject of TEACHING_SUBJECTS) {
                if (subject === teachingSubject || 
                    subject.startsWith(teachingSubject + ' ') ||
                    subject.startsWith(teachingSubject + ':')) {
                    return true;
                }
            }

            // Third: Short 2-3 letter codes with a group are likely lessons
            if (group && /^\d+[A-Z]$/i.test(group)) {
                const shortCode = /^[a-z]{2,3}$/i;
                if (shortCode.test(subject)) {
                    return true;
                }
            }

            return false;
        }

        /**
         * Classify if an activity is a lesson (for display purposes).
         * This is more permissive than isTeachingLesson - used for schedule display.
         */
        function isLesson(lesson) {
            const subject = (lesson[columnMap['subject']] || '').trim().toLowerCase();
            const group = (lesson[columnMap['group']] || '').trim();

            // Check for non-lesson keywords
            for (const keyword of NON_LESSON_KEYWORDS) {
                if (subject.includes(keyword)) {
                    return false;
                }
            }

            // Check teaching subjects
            for (const teachingSubject of TEACHING_SUBJECTS) {
                if (subject === teachingSubject || 
                    subject.startsWith(teachingSubject + ' ') ||
                    subject.startsWith(teachingSubject + ':') ||
                    subject.includes(' ' + teachingSubject + ' ') ||
                    subject.includes(' ' + teachingSubject + ':')) {
                    return true;
                }
            }

            // Has a valid group pattern (like 5A, 6B)
            if (group && /^\d+[A-Z]$/i.test(group)) {
                return true;
            }

            return false;
        }

        // ============================================================================
        // AVAILABILITY CALCULATIONS
        // ============================================================================

        function getAvailabilityAtTime(checkTime) {
            const checkWeekNum = getCalendarWeek(checkTime);
            const checkDay = dayMap[checkTime.getDay()];
            const checkTimeInMinutes = (checkTime.getHours() * 60) + checkTime.getMinutes();

            const busyTeachers = new Set();
            const workingTeachers = new Map(); // teacher -> arbetstid end time
            const teacherArbetstidEnds = new Map();

            // Filter lessons that might apply to this time
            const filteredLessons = lessons.filter(lesson => {
                const subject = lesson[columnMap['subject']]?.trim().toLowerCase();
                return subject !== ARBETSTID_SUBJECT || !lessonsOnlyMode;
            });

            // First pass: find Arbetstid end times
            lessons.forEach(lesson => {
                const lessonDay = lesson[columnMap['day']]?.trim();
                const weekString = lesson[columnMap['realweeks']];
                const subject = lesson[columnMap['subject']]?.trim().toLowerCase();
                const startStr = lesson[columnMap['starttime']];
                const lenStr = lesson[columnMap['length']];
                const teacherStr = lesson[columnMap['teacher']]?.trim();

                if (!lessonDay || !weekString || !startStr || !lenStr || !teacherStr) return;
                if (subject !== ARBETSTID_SUBJECT) return;

                const lessonWeeks = parseRealWeeks(weekString);
                if (lessonDay !== checkDay || !lessonWeeks.has(checkWeekNum)) return;

                const lessonStart = timeToMinutes(startStr);
                const lessonLength = parseInt(lenStr, 10);
                if (isNaN(lessonLength) || lessonLength <= 0) return;
                const lessonEnd = lessonStart + lessonLength;

                const teachers = parseTeachers(teacherStr);
                teachers.forEach(t => {
                    const currentEnd = teacherArbetstidEnds.get(t) || 0;
                    if (lessonEnd > currentEnd) {
                        teacherArbetstidEnds.set(t, lessonEnd);
                    }
                });
            });

            // Second pass: find busy and available teachers
            filteredLessons.forEach(lesson => {
                const lessonDay = lesson[columnMap['day']]?.trim();
                const weekString = lesson[columnMap['realweeks']];
                const subject = lesson[columnMap['subject']]?.trim().toLowerCase();
                const startStr = lesson[columnMap['starttime']];
                const lenStr = lesson[columnMap['length']];
                const teacherStr = lesson[columnMap['teacher']]?.trim();

                if (!lessonDay || !weekString || !subject || !startStr || !lenStr || !teacherStr) return;

                const lessonWeeks = parseRealWeeks(weekString);
                if (lessonDay !== checkDay || !lessonWeeks.has(checkWeekNum)) return;

                const lessonStart = timeToMinutes(startStr);
                const lessonLength = parseInt(lenStr, 10);
                if (isNaN(lessonLength) || lessonLength <= 0) return;
                const lessonEnd = lessonStart + lessonLength;

                if (checkTimeInMinutes >= lessonStart && checkTimeInMinutes < lessonEnd) {
                    const teachers = parseTeachers(teacherStr);
                    
                    if (teachers.length === 0) return;
                    
                    if (lessonsOnlyMode) {
                        // In lessons-only mode, only actual lessons make teachers busy
                        if (isLesson(lesson)) {
                            teachers.forEach(t => {
                                busyTeachers.add(t);
                                workingTeachers.delete(t);
                            });
                        }
                    } else {
                        // Standard mode: Arbetstid = available, other activities = busy
                        if (subject === ARBETSTID_SUBJECT) {
                            teachers.forEach(t => {
                                if (!busyTeachers.has(t)) {
                                    const endTime = teacherArbetstidEnds.get(t) || lessonEnd;
                                    workingTeachers.set(t, endTime);
                                }
                            });
                        } else {
                            teachers.forEach(t => {
                                busyTeachers.add(t);
                                workingTeachers.delete(t);
                            });
                        }
                    }
                }
            });

            // Build available teachers list with end times
            // Now we collect ALL available staff and separate them at the end
            const allAvailable = [];
            
            if (lessonsOnlyMode) {
                // Get ALL teachers from data (including admin, excluding only MT and manual exclusions)
                const allTeachersSet = new Set();
                lessons.forEach(lesson => {
                    const teacherStr = lesson[columnMap['teacher']]?.trim();
                    if (teacherStr) {
                        parseTeachers(teacherStr).forEach(t => {
                            if (t && !shouldExcludeCompletely(t)) {
                                allTeachersSet.add(t);
                            }
                        });
                    }
                });

                allTeachersSet.forEach(teacher => {
                    if (!busyTeachers.has(teacher)) {
                        let nextLessonStart = null;
                        filteredLessons.forEach(lesson => {
                            const lessonDay = lesson[columnMap['day']]?.trim();
                            const weekString = lesson[columnMap['realweeks']];
                            const startStr = lesson[columnMap['starttime']];
                            const teacherStr = lesson[columnMap['teacher']]?.trim();
                            
                            if (!lessonDay || !weekString || !startStr || !teacherStr) return;
                            if (!isLesson(lesson)) return;
                            
                            const lessonWeeks = parseRealWeeks(weekString);
                            if (lessonDay !== checkDay || !lessonWeeks.has(checkWeekNum)) return;
                            
                            const teachers = parseTeachers(teacherStr);
                            if (teachers.includes(teacher)) {
                                const lessonStart = timeToMinutes(startStr);
                                if (lessonStart > checkTimeInMinutes && (!nextLessonStart || lessonStart < nextLessonStart)) {
                                    nextLessonStart = lessonStart;
                                }
                            }
                        });
                        
                        allAvailable.push({ 
                            teacher, 
                            endTime: nextLessonStart || (checkTimeInMinutes + 60),
                            isAdmin: isAdminStaff(teacher)
                        });
                    }
                });
            } else {
                workingTeachers.forEach((endTime, teacher) => {
                    if (!busyTeachers.has(teacher) && !shouldExcludeCompletely(teacher)) {
                        let actualEndTime = endTime;
                        lessons.forEach(lesson => {
                            const lessonDay = lesson[columnMap['day']]?.trim();
                            const weekString = lesson[columnMap['realweeks']];
                            const subject = lesson[columnMap['subject']]?.trim().toLowerCase();
                            const startStr = lesson[columnMap['starttime']];
                            const teacherStr = lesson[columnMap['teacher']]?.trim();

                            if (!lessonDay || !weekString || !subject || !startStr || !teacherStr) return;
                            if (subject === ARBETSTID_SUBJECT) return;

                            const lessonWeeks = parseRealWeeks(weekString);
                            if (lessonDay !== checkDay || !lessonWeeks.has(checkWeekNum)) return;

                            const lessonStart = timeToMinutes(startStr);
                            const teachers = parseTeachers(teacherStr);
                            
                            if (teachers.includes(teacher) && lessonStart > checkTimeInMinutes && lessonStart < actualEndTime) {
                                actualEndTime = lessonStart;
                            }
                        });
                        allAvailable.push({ 
                            teacher, 
                            endTime: actualEndTime,
                            isAdmin: isAdminStaff(teacher)
                        });
                    }
                });
            }

            // Separate into teaching and admin staff, filtering out user-excluded staff
            const teachingStaff = allAvailable
                .filter(t => !t.isAdmin && !shouldFilterExcluded(t.teacher))
                .sort((a, b) => a.teacher.localeCompare(b.teacher));
            const adminStaff = allAvailable
                .filter(t => t.isAdmin && !shouldFilterExcluded(t.teacher))
                .sort((a, b) => a.teacher.localeCompare(b.teacher));

            return {
                available: teachingStaff,  // For backwards compatibility
                teachingStaff,
                adminStaff
            };
        }

        function getAvailabilityForRange(checkDate, checkStartMinutes, checkEndMinutes) {
            const checkWeekNum = getCalendarWeek(checkDate);
            const checkDay = dayMap[checkDate.getDay()];

            const busyTeachers = new Set();
            const workingTeachers = new Map();
            const teacherArbetstidEnds = new Map();

            const filteredLessons = lessons.filter(lesson => {
                const subject = lesson[columnMap['subject']]?.trim().toLowerCase();
                return subject !== ARBETSTID_SUBJECT || !lessonsOnlyMode;
            });

            // First pass: find Arbetstid coverage
            lessons.forEach(lesson => {
                const lessonDay = lesson[columnMap['day']]?.trim();
                const weekString = lesson[columnMap['realweeks']];
                const subject = lesson[columnMap['subject']]?.trim().toLowerCase();
                const startStr = lesson[columnMap['starttime']];
                const lenStr = lesson[columnMap['length']];
                const teacherStr = lesson[columnMap['teacher']]?.trim();

                if (!lessonDay || !weekString || !startStr || !lenStr || !teacherStr) return;
                if (subject !== ARBETSTID_SUBJECT) return;

                const lessonWeeks = parseRealWeeks(weekString);
                if (lessonDay !== checkDay || !lessonWeeks.has(checkWeekNum)) return;

                const lessonStart = timeToMinutes(startStr);
                const lessonLength = parseInt(lenStr, 10);
                if (isNaN(lessonLength) || lessonLength <= 0) return;
                const lessonEnd = lessonStart + lessonLength;

                if (lessonStart <= checkStartMinutes && lessonEnd >= checkEndMinutes) {
                    const teachers = parseTeachers(teacherStr);
                    teachers.forEach(t => {
                        const currentEnd = teacherArbetstidEnds.get(t) || 0;
                        if (lessonEnd > currentEnd) {
                            teacherArbetstidEnds.set(t, lessonEnd);
                            if (!workingTeachers.has(t)) {
                                workingTeachers.set(t, lessonEnd);
                            }
                        }
                    });
                }
            });

            // Second pass: find busy teachers
            filteredLessons.forEach(lesson => {
                const lessonDay = lesson[columnMap['day']]?.trim();
                const weekString = lesson[columnMap['realweeks']];
                const subject = lesson[columnMap['subject']]?.trim().toLowerCase();
                const startStr = lesson[columnMap['starttime']];
                const lenStr = lesson[columnMap['length']];
                const teacherStr = lesson[columnMap['teacher']]?.trim();

                if (!lessonDay || !weekString || !subject || !startStr || !lenStr || !teacherStr) return;

                const lessonWeeks = parseRealWeeks(weekString);
                if (lessonDay !== checkDay || !lessonWeeks.has(checkWeekNum)) return;

                const lessonStart = timeToMinutes(startStr);
                const lessonLength = parseInt(lenStr, 10);
                if (isNaN(lessonLength) || lessonLength <= 0) return;
                const lessonEnd = lessonStart + lessonLength;

                // Check if lesson overlaps with query range
                if (lessonStart < checkEndMinutes && lessonEnd > checkStartMinutes) {
                    const teachers = parseTeachers(teacherStr);
                    
                    if (lessonsOnlyMode) {
                        if (isLesson(lesson)) {
                            teachers.forEach(t => {
                                busyTeachers.add(t);
                                workingTeachers.delete(t);
                            });
                        }
                    } else {
                        if (subject !== ARBETSTID_SUBJECT) {
                            teachers.forEach(t => {
                                busyTeachers.add(t);
                                workingTeachers.delete(t);
                            });
                        }
                    }
                }
            });

            // Build available teachers list
            const availableWithEndTimes = [];
            
            if (lessonsOnlyMode) {
                const allTeachersSet = new Set();
                getAllTeachers().forEach(t => allTeachersSet.add(t));
                
                allTeachersSet.forEach(teacher => {
                    if (!busyTeachers.has(teacher) && !shouldExcludeFromAvailability(teacher)) {
                        let actualEndTime = checkEndMinutes;
                        
                        filteredLessons.forEach(lesson => {
                            const lessonDay = lesson[columnMap['day']]?.trim();
                            const weekString = lesson[columnMap['realweeks']];
                            const startStr = lesson[columnMap['starttime']];
                            const teacherStr = lesson[columnMap['teacher']]?.trim();
                            
                            if (!lessonDay || !weekString || !startStr || !teacherStr) return;
                            if (!isLesson(lesson)) return;
                            
                            const lessonWeeks = parseRealWeeks(weekString);
                            if (lessonDay !== checkDay || !lessonWeeks.has(checkWeekNum)) return;
                            
                            const teachers = parseTeachers(teacherStr);
                            if (teachers.includes(teacher)) {
                                const lessonStart = timeToMinutes(startStr);
                                if (lessonStart >= checkStartMinutes && lessonStart < actualEndTime) {
                                    actualEndTime = lessonStart;
                                }
                            }
                        });
                        
                        availableWithEndTimes.push({ teacher, endTime: actualEndTime });
                    }
                });
            } else {
                workingTeachers.forEach((endTime, teacher) => {
                    if (!busyTeachers.has(teacher) && !shouldExcludeFromAvailability(teacher)) {
                        let actualEndTime = Math.min(endTime, checkEndMinutes);
                        
                        lessons.forEach(lesson => {
                            const lessonDay = lesson[columnMap['day']]?.trim();
                            const weekString = lesson[columnMap['realweeks']];
                            const subject = lesson[columnMap['subject']]?.trim().toLowerCase();
                            const startStr = lesson[columnMap['starttime']];
                            const teacherStr = lesson[columnMap['teacher']]?.trim();

                            if (!lessonDay || !weekString || !subject || !startStr || !teacherStr) return;
                            if (subject === ARBETSTID_SUBJECT) return;

                            const lessonWeeks = parseRealWeeks(weekString);
                            if (lessonDay !== checkDay || !lessonWeeks.has(checkWeekNum)) return;

                            const lessonStart = timeToMinutes(startStr);
                            const teachers = parseTeachers(teacherStr);
                            
                            if (teachers.includes(teacher) && lessonStart >= checkStartMinutes && lessonStart < actualEndTime) {
                                actualEndTime = lessonStart;
                            }
                        });
                        
                        const finalEndTime = actualEndTime < checkEndMinutes ? endTime : actualEndTime;
                        availableWithEndTimes.push({ teacher, endTime: finalEndTime });
                    }
                });
            }

            // Filter out user-excluded staff and sort
            const filteredAvailable = availableWithEndTimes
                .filter(t => !shouldFilterExcluded(t.teacher))
                .sort((a, b) => a.teacher.localeCompare(b.teacher));
            return { available: filteredAvailable };
        }

        // ============================================================================
        // DISPLAY FUNCTIONS
        // ============================================================================

        function displayResults(availableTeachers, listElement, statusElement, currentTime = null) {
            listElement.innerHTML = '';
            
            if (availableTeachers.length === 0) {
                const modeText = lessonsOnlyMode ? ' (Lessons Only)' : '';
                statusElement.textContent = `No available teachers found${modeText}`;
                statusElement.classList.remove('error');
                return;
            }

            const modeText = lessonsOnlyMode ? ' (Lessons Only)' : '';
            statusElement.textContent = `${availableTeachers.length} teacher${availableTeachers.length !== 1 ? 's' : ''} available${modeText}`;
            
            const now = currentTime || new Date();
            const nowMinutes = (now.getHours() * 60) + now.getMinutes();
            
            availableTeachers.forEach(item => {
                const li = document.createElement('li');
                const teacher = typeof item === 'string' ? item : item.teacher;
                const endTime = typeof item === 'object' && item.endTime ? item.endTime : null;
                
                if (endTime && currentTime) {
                    const endMinutes = endTime;
                    const durationMinutes = endMinutes - nowMinutes;
                    const durationHours = Math.floor(durationMinutes / 60);
                    const durationMins = durationMinutes % 60;
                    const endTimeStr = minutesToHHMM(endMinutes);
                    
                    let durationText = '';
                    if (durationHours > 0 && durationMins > 0) {
                        durationText = ` (${durationHours}h ${durationMins}m until ${endTimeStr})`;
                    } else if (durationHours > 0) {
                        durationText = ` (${durationHours}h until ${endTimeStr})`;
                    } else if (durationMins > 0) {
                        durationText = ` (${durationMins}m until ${endTimeStr})`;
                    } else {
                        durationText = ` (until ${endTimeStr})`;
                    }
                    
                    li.textContent = teacher + durationText;
                } else {
                    li.textContent = teacher;
                }
                
                listElement.appendChild(li);
            });
        }

        // ============================================================================
        // DATA LOADING
        // ============================================================================

        async function loadData(fileContent) {
            try {
                statusNow.textContent = 'Loading schedule...';
                
                let text;
                if (fileContent) {
                    text = fileContent;
                } else {
                    try {
                        const response = await fetch('Lessons.txt?v=' + new Date().getTime());
                        if (!response.ok) throw new Error('File not found');
                        const buffer = await response.arrayBuffer();
                        const decoder = new TextDecoder('utf-8');
                        text = decoder.decode(buffer);
                    } catch (fetchError) {
                        statusNow.textContent = 'Please select the Lessons.txt file using the file input above.';
                        statusNow.classList.add('error');
                        return;
                    }
                }

                const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
                if (lines.length < 2) throw new Error('Invalid schedule file');

                const header = lines[0].split('\t');
                columnMap = {}; // Reset column map
                header.forEach((c, i) => { columnMap[c.trim()] = i; });

                const expectedColumns = header.length;
                lessons = lines.slice(1).map(line => {
                    const columns = line.split('\t');
                    while (columns.length < expectedColumns) columns.push('');
                    if (columns.length > expectedColumns) columns.length = expectedColumns;
                    return columns;
                });

                // Reset Mother Tongue cache so it's recalculated
                motherTongueTeachersCache = null;

                // Update data status indicator
                dataStatusEl.classList.remove('not-loaded');
                dataStatusEl.classList.add('loaded');
                dataStatusText.textContent = `‚úì Loaded ${lessons.length} entries`;

                // Set default input values
                const now = new Date();
                dateInput.valueAsDate = now;
                const currentTime = now.toTimeString().substring(0, 5);
                timeFromInput.value = clampTimeToRange(currentTime);
                const later = new Date(now.getTime() + 60 * 60 * 1000);
                const laterTime = later.toTimeString().substring(0, 5);
                timeToInput.value = clampTimeToRange(laterTime);

                // Show current availability
                updateAvailableNow();
                
                // Update availability and recommendations every minute
                setInterval(() => {
                    updateAvailableNow();
                    updateRecommendedForCover();
                }, 60000);
                
                // Populate all teachers list
                populateAllTeachersList();
                
                // Update recommended for cover section
                updateRecommendedForCover();
                
                // Update analytics dashboard
                updateAnalytics();

                // Log configuration info
                console.log('[CONFIG] Teaching subjects:', Array.from(TEACHING_SUBJECTS));
                console.log('[CONFIG] Manual exclusions:', Array.from(MANUAL_EXCLUDE_LIST));
                detectMotherTongueTeachers(); // This will log detected MT teachers

            } catch (error) {
                statusNow.textContent = `Error: ${error.message}`;
                statusNow.classList.add('error');
                console.error('Load error:', error);
            }
        }

        function updateAvailableNow() {
            const teachingListEl = document.getElementById('teachers-now-teaching');
            const adminListEl = document.getElementById('teachers-now-admin');
            const statusTeaching = document.getElementById('status-teaching');
            const statusAdmin = document.getElementById('status-admin');

            if (lessons.length === 0) {
                statusNow.textContent = 'Please load schedule file first';
                statusNow.classList.remove('error');
                teachingListEl.innerHTML = '';
                adminListEl.innerHTML = '';
                return;
            }
            
            const now = new Date();
            const { teachingStaff, adminStaff } = getAvailabilityAtTime(now);
            
            // Update main status
            const modeText = lessonsOnlyMode ? ' (Lessons Only)' : '';
            statusNow.textContent = `${teachingStaff.length} teaching staff available${modeText}`;
            statusNow.classList.remove('error');
            
            // Display teaching staff with duration AND Assign button
            displayAvailableList(teachingStaff, teachingListEl, now, true);
            statusTeaching.textContent = `${teachingStaff.length} available for cover`;
            
            // Display admin staff with duration (no Assign button)
            displayAvailableList(adminStaff, adminListEl, now, false);
            statusAdmin.textContent = `${adminStaff.length} available`;
        }

        /**
         * Update the Recommended for Cover section
         * Default: Shows TEACHING STAFF available RIGHT NOW, ranked by lowest hours
         * Planning Mode: Shows ALL teaching staff, ranked by lowest hours
         * Include Other: Optionally includes "Other" category staff
         */
        function updateRecommendedForCover() {
            const emptyEl = document.getElementById('recommended-empty');
            const listEl = document.getElementById('recommended-list');
            const descriptionEl = document.getElementById('recommended-description');
            
            if (lessons.length === 0) {
                emptyEl.style.display = 'block';
                emptyEl.innerHTML = '<p>Load a schedule file to see recommendations</p>';
                listEl.style.display = 'none';
                return;
            }
            
            const now = new Date();
            const currentWeek = getCalendarWeek(now);
            const threshold = HOUR_THRESHOLD_WARNING; // 18 hours
            
            // Get staff categories
            const { teachingStaff, otherStaff } = getAllTeachersSeparated();

            // Build the pool of eligible staff based on toggle, filtering out excluded staff
            let eligibleStaff = teachingStaff.filter(t => !shouldFilterExcluded(t));
            if (includeOtherStaffInRecommendations) {
                const filteredOther = otherStaff.filter(t => !shouldFilterExcluded(t));
                eligibleStaff = [...eligibleStaff, ...filteredOther];
            }
            const eligibleSet = new Set(eligibleStaff);
            
            let teachersToRank = [];
            let descriptionText = '';
            
            if (showAllWeekRecommendations) {
                // PLANNING MODE: Get all eligible staff
                teachersToRank = eligibleStaff;
                descriptionText = includeOtherStaffInRecommendations
                    ? 'All staff ranked by lowest scheduled hours (planning mode)'
                    : 'Teaching staff ranked by lowest scheduled hours (planning mode)';
            } else {
                // DEFAULT MODE: Get only eligible staff who are available RIGHT NOW
                const { teachingStaff: availableTeaching, adminStaff: availableAdmin } = getAvailabilityAtTime(now);
                
                // Filter to only include those in our eligible pool
                const availableNames = availableTeaching.map(t => t.teacher);
                teachersToRank = availableNames.filter(name => eligibleSet.has(name));
                
                descriptionText = includeOtherStaffInRecommendations
                    ? 'Staff available RIGHT NOW, ranked by lowest scheduled hours'
                    : 'Teaching staff available RIGHT NOW, ranked by lowest scheduled hours';
            }
            
            descriptionEl.textContent = descriptionText;
            
            // Handle no teachers available
            if (teachersToRank.length === 0) {
                emptyEl.style.display = 'block';
                emptyEl.innerHTML = showAllWeekRecommendations 
                    ? '<p>No staff found</p>'
                    : '<p>No teaching staff available right now</p><p class="empty-hint">Try the "Show All Week" toggle to see all staff</p>';
                listEl.style.display = 'none';
                return;
            }
            
            // Calculate hours and spare capacity for each teacher
            const teachersWithHours = teachersToRank.map(teacher => {
                const weeklyHours = getWeeklyTeachingHours(teacher);
                const currentHours = weeklyHours.get(currentWeek) || 0;
                const spareCapacity = threshold - currentHours;
                const isOther = otherStaff.includes(teacher);
                
                return {
                    name: teacher,
                    hours: currentHours,
                    spare: spareCapacity,
                    isOther: isOther
                };
            });
            
            // Sort by spare capacity (highest first = lowest hours)
            teachersWithHours.sort((a, b) => b.spare - a.spare);
            
            // Take top 10 recommendations
            const topRecommendations = teachersWithHours.slice(0, 25);
            
            // Build the display
            emptyEl.style.display = 'none';
            listEl.style.display = 'grid';
            listEl.innerHTML = '';
            
            topRecommendations.forEach((teacher, index) => {
                const card = document.createElement('div');
                card.className = 'recommended-card' + (index === 0 ? ' top-pick' : '') + (teacher.isOther ? ' other-staff' : '');
                
                // Determine spare capacity status
                let spareClass = '';
                let spareText = '';
                if (teacher.spare <= 0) {
                    spareClass = 'danger';
                    spareText = 'At limit';
                } else if (teacher.spare < 2) {
                    spareClass = 'warning';
                    spareText = `${teacher.spare.toFixed(1)}h spare`;
                } else {
                    spareText = `${teacher.spare.toFixed(1)}h spare`;
                }
                
                // Add "Other" badge if applicable
                const otherBadge = teacher.isOther ? '<span class="other-badge">Other</span>' : '';
                
                card.innerHTML = `
                    <div class="recommended-rank">${index === 0 ? '‚≠ê Top Pick' : '#' + (index + 1)} ${otherBadge}</div>
                    <div class="recommended-name">${teacher.name}</div>
                    <div class="recommended-hours">
                        <span class="recommended-hours-value">${teacher.hours.toFixed(1)}h this week</span>
                        <span class="recommended-spare ${spareClass}">${spareText}</span>
                    </div>
                `;
                
                listEl.appendChild(card);
            });
        }

        // ============================================================================
        // ANALYTICS DASHBOARD FUNCTIONS
        // ============================================================================

        /**
         * Update all analytics dashboard data
         * Called whenever data is loaded
         */
        function updateAnalytics() {
            const emptyEl = document.getElementById('analytics-empty');
            const contentEl = document.getElementById('analytics-content');
            
            if (lessons.length === 0) {
                if (emptyEl) emptyEl.style.display = 'block';
                if (contentEl) contentEl.style.display = 'none';
                return;
            }
            
            if (emptyEl) emptyEl.style.display = 'none';
            if (contentEl) contentEl.style.display = 'block';
            
            // Calculate all analytics
            const analytics = calculateAllAnalytics();
            
            // Update all sections
            updateCapacityOverview(analytics);
            updateStaffSummary(analytics);
            updateSubjectAnalysis(analytics);
            updateRoomAnalysis(analytics);
            updateSchedulePatterns(analytics);
            updateRiskAnalysis(analytics);
            updateYearGroupAnalysis(analytics);
        }

        /**
         * Calculate all analytics data from lessons
         */
        function calculateAllAnalytics() {
            const now = new Date();
            const currentWeek = getCalendarWeek(now);

            // Get staff categories and filter out excluded staff (respects analytics toggle)
            const allStaff = getAllTeachersSeparated();
            const teachingStaff = allStaff.teachingStaff.filter(t => !shouldFilterExcludedFromAnalytics(t));
            const otherStaff = allStaff.otherStaff.filter(t => !shouldFilterExcludedFromAnalytics(t));
            const adminStaff = allStaff.adminStaff.filter(t => !shouldFilterExcludedFromAnalytics(t));

            // Calculate teaching hours for each teacher (only non-excluded)
            const teacherHours = new Map();
            teachingStaff.forEach(teacher => {
                const weeklyHours = getWeeklyTeachingHours(teacher);
                const hours = weeklyHours.get(currentWeek) || 0;
                teacherHours.set(teacher, hours);
            });
            
            // Subject analysis
            const subjectData = analyzeSubjects(currentWeek);
            
            // Room analysis
            const roomData = analyzeRooms(currentWeek);
            
            // Schedule patterns
            const schedulePatterns = analyzeSchedulePatterns(currentWeek);
            
            // Year group analysis
            const yearGroupData = analyzeYearGroups(currentWeek);
            
            // Calculate totals
            let totalTeachingHours = 0;
            let teachersAtCapacity = 0;
            let teachersOverLimit = 0;
            
            teacherHours.forEach((hours, teacher) => {
                totalTeachingHours += hours;
                if (hours >= HOUR_THRESHOLD_DANGER) {
                    teachersOverLimit++;
                } else if (hours >= HOUR_THRESHOLD_WARNING) {
                    teachersAtCapacity++;
                }
            });
            
            const theoreticalCapacity = teachingStaff.length * HOUR_THRESHOLD_WARNING;
            const capacityUtilization = theoreticalCapacity > 0 ? (totalTeachingHours / theoreticalCapacity) * 100 : 0;
            const unusedCapacity = Math.max(0, theoreticalCapacity - totalTeachingHours);
            const avgHoursPerTeacher = teachingStaff.length > 0 ? totalTeachingHours / teachingStaff.length : 0;
            
            return {
                teachingStaff,
                otherStaff,
                adminStaff,
                teacherHours,
                theoreticalCapacity,
                totalTeachingHours,
                capacityUtilization,
                unusedCapacity,
                avgHoursPerTeacher,
                teachersAtCapacity,
                teachersOverLimit,
                subjectData,
                roomData,
                schedulePatterns,
                yearGroupData,
                currentWeek
            };
        }

        /**
         * Analyze subjects taught
         */
        function analyzeSubjects(targetWeek) {
            const subjects = new Map(); // subject -> { hours, teachers, rooms }
            
            lessons.forEach(lesson => {
                const subject = lesson[columnMap['subject']]?.trim().toLowerCase();
                const weekString = lesson[columnMap['realweeks']];
                const teacherStr = lesson[columnMap['teacher']]?.trim();
                const lengthStr = lesson[columnMap['length']];
                const room = lesson[columnMap['room']]?.trim() || 'Unknown';
                
                if (!subject || !weekString || !lengthStr) return;
                if (!isLesson(lesson)) return;
                
                const lessonWeeks = parseRealWeeks(weekString);
                if (!lessonWeeks.has(targetWeek)) return;
                
                const length = parseInt(lengthStr, 10) || 0;
                const teachers = parseTeachers(teacherStr);
                
                if (!subjects.has(subject)) {
                    subjects.set(subject, { hours: 0, teachers: new Set(), rooms: new Set() });
                }
                
                const data = subjects.get(subject);
                data.hours += length / 60; // Convert to hours
                // Only add non-excluded teachers to subject analysis (respects analytics toggle)
                teachers.forEach(t => {
                    if (!shouldFilterExcludedFromAnalytics(t)) {
                        data.teachers.add(t);
                    }
                });
                if (room) data.rooms.add(room);
            });
            
            // Convert to array and sort by hours
            const subjectArray = Array.from(subjects.entries()).map(([name, data]) => ({
                name: name.toUpperCase(),
                hours: data.hours,
                teacherCount: data.teachers.size,
                teachers: Array.from(data.teachers),
                rooms: Array.from(data.rooms)
            }));
            
            subjectArray.sort((a, b) => b.hours - a.hours);
            
            // Find single-teacher subjects
            const singleTeacherSubjects = subjectArray.filter(s => s.teacherCount === 1);
            
            return {
                subjects: subjectArray,
                totalSubjects: subjectArray.length,
                singleTeacherSubjects
            };
        }

        /**
         * Analyze room usage
         */
        function analyzeRooms(targetWeek) {
            const rooms = new Map(); // room -> { hours, subjects }
            
            lessons.forEach(lesson => {
                const room = lesson[columnMap['room']]?.trim();
                const weekString = lesson[columnMap['realweeks']];
                const lengthStr = lesson[columnMap['length']];
                const subject = lesson[columnMap['subject']]?.trim().toLowerCase();
                
                if (!room || !weekString || !lengthStr) return;
                if (!isLesson(lesson)) return;
                
                const lessonWeeks = parseRealWeeks(weekString);
                if (!lessonWeeks.has(targetWeek)) return;
                
                const length = parseInt(lengthStr, 10) || 0;
                
                if (!rooms.has(room)) {
                    rooms.set(room, { hours: 0, subjects: new Set() });
                }
                
                const data = rooms.get(room);
                data.hours += length / 60;
                if (subject) data.subjects.add(subject.toUpperCase());
            });
            
            // Convert to array and sort by hours
            const roomArray = Array.from(rooms.entries()).map(([name, data]) => ({
                name,
                hours: data.hours,
                subjects: Array.from(data.subjects)
            }));
            
            roomArray.sort((a, b) => b.hours - a.hours);
            
            const totalHours = roomArray.reduce((sum, r) => sum + r.hours, 0);
            const avgHours = roomArray.length > 0 ? totalHours / roomArray.length : 0;
            
            return {
                rooms: roomArray,
                totalRooms: roomArray.length,
                busiestRoom: roomArray[0] || null,
                avgHoursPerRoom: avgHours
            };
        }

        /**
         * Analyze schedule patterns (busiest days, peak hours by day)
         */
        function analyzeSchedulePatterns(targetWeek) {
            const dayLessons = { Mon: 0, Tue: 0, Wed: 0, Thur: 0, Fri: 0 };
            const hourBuckets = {}; // hour -> count of lessons (all week)
            const hourBucketsByDay = { // day -> { hour -> count }
                Mon: {}, Tue: {}, Wed: {}, Thur: {}, Fri: {}
            };
            const studentGroupsByHour = {}; // hour -> Set of groups in class
            const studentGroupsByHourByDay = {}; // day -> { hour -> Set of groups }
            
            // Initialize hour buckets (8am to 5pm)
            for (let h = 8; h <= 17; h++) {
                hourBuckets[h] = 0;
                studentGroupsByHour[h] = new Set();
                Object.keys(hourBucketsByDay).forEach(day => {
                    hourBucketsByDay[day][h] = 0;
                    if (!studentGroupsByHourByDay[day]) studentGroupsByHourByDay[day] = {};
                    studentGroupsByHourByDay[day][h] = new Set();
                });
            }
            
            // Count unique student groups for "free" calculation
            const allStudentGroups = new Set();
            
            lessons.forEach(lesson => {
                const day = lesson[columnMap['day']]?.trim();
                const weekString = lesson[columnMap['realweeks']];
                const startStr = lesson[columnMap['starttime']];
                const lengthStr = lesson[columnMap['length']];
                const group = lesson[columnMap['group']]?.trim();
                
                if (!day || !weekString || !startStr) return;
                if (!isLesson(lesson)) return;
                
                const lessonWeeks = parseRealWeeks(weekString);
                if (!lessonWeeks.has(targetWeek)) return;
                
                // Track student groups (only actual class groups like 4A, 5B, etc.)
                if (group && /^\d+[A-Za-z]$/.test(group)) {
                    allStudentGroups.add(group);
                }
                
                // Count lessons per day
                if (dayLessons.hasOwnProperty(day)) {
                    dayLessons[day]++;
                }
                
                // Count lessons per hour
                const startMinutes = timeToMinutes(startStr);
                const length = parseInt(lengthStr, 10) || 0;
                const startHour = Math.floor(startMinutes / 60);
                const endHour = Math.floor((startMinutes + length) / 60);
                
                for (let h = startHour; h < endHour && h <= 17; h++) {
                    if (hourBuckets.hasOwnProperty(h)) {
                        hourBuckets[h]++;
                        
                        // Track by day
                        if (hourBucketsByDay[day]) {
                            hourBucketsByDay[day][h]++;
                        }
                        
                        // Track which student groups are in class
                        if (group && /^\d+[A-Za-z]$/.test(group)) {
                            studentGroupsByHour[h].add(group);
                            if (studentGroupsByHourByDay[day]) {
                                studentGroupsByHourByDay[day][h].add(group);
                            }
                        }
                    }
                }
            });
            
            // Find busiest and quietest days
            const dayArray = Object.entries(dayLessons).map(([name, count]) => ({ name, count }));
            dayArray.sort((a, b) => b.count - a.count);
            
            const busiestDay = dayArray[0];
            const quietestDay = dayArray[dayArray.length - 1];
            
            // Find peak hours
            const hourArray = Object.entries(hourBuckets).map(([hour, count]) => ({ hour: parseInt(hour), count }));
            hourArray.sort((a, b) => b.count - a.count);
            
            const maxHourCount = hourArray[0]?.count || 1;
            
            // Calculate "students not in class" - inverse of students in class
            const totalGroups = allStudentGroups.size;
            const freeStudentsByHour = {};
            for (let h = 8; h <= 17; h++) {
                freeStudentsByHour[h] = totalGroups - studentGroupsByHour[h].size;
            }
            
            return {
                dayLessons,
                busiestDay,
                quietestDay,
                hourBuckets,
                hourBucketsByDay,
                peakHour: hourArray[0],
                maxHourCount,
                allStudentGroups,
                totalGroups,
                studentGroupsByHour,
                studentGroupsByHourByDay,
                freeStudentsByHour
            };
        }

        /**
         * Analyze year groups
         * Only counts actual class groups (pattern: digit + letter, like 4A, 5B, 6C)
         * Now also tracks subjects and teachers per group for detailed breakdown
         */
        function analyzeYearGroups(targetWeek) {
            const groups = new Map(); // group -> { hours, teachers, subjects }
            
            // Regex for actual class groups: one or more digits followed by a letter
            // Matches: 4A, 5B, 6C, 7A, 8B, 9C, etc.
            const classGroupPattern = /^\d+[A-Za-z]$/;
            
            lessons.forEach(lesson => {
                const group = lesson[columnMap['group']]?.trim();
                const weekString = lesson[columnMap['realweeks']];
                const lengthStr = lesson[columnMap['length']];
                const teacherStr = lesson[columnMap['teacher']]?.trim();
                const subject = lesson[columnMap['subject']]?.trim();
                
                if (!group || !weekString || !lengthStr) return;
                if (!isLesson(lesson)) return;
                
                // Only count actual class groups (like 4A, 5B, 6C)
                if (!classGroupPattern.test(group)) return;
                
                const lessonWeeks = parseRealWeeks(weekString);
                if (!lessonWeeks.has(targetWeek)) return;
                
                const length = parseInt(lengthStr, 10) || 0;
                const teachers = parseTeachers(teacherStr);
                const subjectUpper = subject?.toUpperCase() || 'UNKNOWN';
                
                if (!groups.has(group)) {
                    groups.set(group, { 
                        hours: 0, 
                        teachers: new Set(),
                        subjects: new Map() // subject -> { hours, teachers, lessonCount }
                    });
                }
                
                const data = groups.get(group);
                data.hours += length / 60;
                teachers.forEach(t => data.teachers.add(t));
                
                // Track per-subject data
                if (!data.subjects.has(subjectUpper)) {
                    data.subjects.set(subjectUpper, { 
                        hours: 0, 
                        teachers: new Set(),
                        lessonCount: 0
                    });
                }
                const subjectData = data.subjects.get(subjectUpper);
                subjectData.hours += length / 60;
                subjectData.lessonCount++;
                teachers.forEach(t => subjectData.teachers.add(t));
            });
            
            // Convert to array and sort by name (to group by year)
            const groupArray = Array.from(groups.entries()).map(([name, data]) => ({
                name,
                hours: data.hours,
                teacherCount: data.teachers.size,
                teachers: Array.from(data.teachers).sort(),
                subjects: Array.from(data.subjects.entries()).map(([subj, subjData]) => ({
                    name: subj,
                    hours: subjData.hours,
                    lessonCount: subjData.lessonCount,
                    teachers: Array.from(subjData.teachers).sort()
                })).sort((a, b) => b.hours - a.hours) // Sort subjects by hours
            }));
            
            // Sort by group name (4A, 4B, 4C, 5A, 5B, etc.)
            groupArray.sort((a, b) => {
                // Extract number and letter
                const aNum = parseInt(a.name.match(/\d+/)?.[0] || '0');
                const bNum = parseInt(b.name.match(/\d+/)?.[0] || '0');
                const aLetter = a.name.match(/[A-Za-z]$/)?.[0] || '';
                const bLetter = b.name.match(/[A-Za-z]$/)?.[0] || '';
                
                if (aNum !== bNum) return aNum - bNum;
                return aLetter.localeCompare(bLetter);
            });
            
            // Find the group with most hours
            const sortedByHours = [...groupArray].sort((a, b) => b.hours - a.hours);
            
            return {
                groups: groupArray,
                totalGroups: groupArray.length,
                busiestGroup: sortedByHours[0] || null
            };
        }

        /**
         * Update Capacity Overview section
         */
        function updateCapacityOverview(analytics) {
            document.getElementById('stat-theoretical').innerHTML = 
                `${analytics.theoreticalCapacity.toFixed(0)}<span class="stat-unit">hrs/wk</span>`;
            document.getElementById('stat-theoretical-detail').textContent = 
                `${analytics.teachingStaff.length} teachers √ó 18h`;
            
            document.getElementById('stat-actual').innerHTML = 
                `${analytics.totalTeachingHours.toFixed(1)}<span class="stat-unit">hrs/wk</span>`;
            
            const utilization = Math.min(analytics.capacityUtilization, 100);
            const utilizationEl = document.getElementById('stat-utilization');
            utilizationEl.innerHTML = `${utilization.toFixed(1)}<span class="stat-unit">%</span>`;
            
            // Color the utilization based on level
            if (utilization > 95) {
                utilizationEl.className = 'stat-value danger';
            } else if (utilization > 85) {
                utilizationEl.className = 'stat-value warning';
            } else {
                utilizationEl.className = 'stat-value';
            }
            
            const barEl = document.getElementById('stat-utilization-bar');
            barEl.style.width = `${utilization}%`;
            if (utilization > 95) {
                barEl.className = 'stat-bar-fill danger';
            } else if (utilization > 85) {
                barEl.className = 'stat-bar-fill warning';
            } else {
                barEl.className = 'stat-bar-fill';
            }
            
            document.getElementById('stat-unused').innerHTML = 
                `${analytics.unusedCapacity.toFixed(1)}<span class="stat-unit">hrs/wk</span>`;
        }

        /**
         * Update Staff Summary section
         */
        // Store analytics data for click handlers
        let currentAnalyticsData = null;
        let staffClickHandlersInitialized = false;
        
        function updateStaffSummary(analytics) {
            // Store for click handlers
            currentAnalyticsData = analytics;
            
            document.getElementById('stat-teaching-count').textContent = analytics.teachingStaff.length;
            document.getElementById('stat-admin-count').textContent = analytics.adminStaff.length;
            document.getElementById('stat-other-count').textContent = analytics.otherStaff.length;
            document.getElementById('stat-avg-hours').innerHTML = 
                `${analytics.avgHoursPerTeacher.toFixed(1)}<span class="stat-unit">hrs</span>`;
            
            // Calculate under capacity count (teachers under 18 hours)
            const teachersUnderCapacity = Array.from(analytics.teacherHours.entries())
                .filter(([name, hours]) => hours < HOUR_THRESHOLD_WARNING).length;
            document.getElementById('stat-under-capacity').textContent = teachersUnderCapacity;
            
            document.getElementById('stat-at-capacity').textContent = analytics.teachersAtCapacity;
            document.getElementById('stat-over-limit').textContent = analytics.teachersOverLimit;
            
            // Update spare capacity list
            const spareList = document.getElementById('spare-capacity-list');
            spareList.innerHTML = '';
            
            // Sort teachers by spare capacity (most spare first)
            const sortedTeachers = Array.from(analytics.teacherHours.entries())
                .map(([name, hours]) => ({ name, hours, spare: HOUR_THRESHOLD_WARNING - hours }))
                .sort((a, b) => b.spare - a.spare)
                .slice(0, 25);
            
            sortedTeachers.forEach(teacher => {
                const li = document.createElement('li');
                li.className = 'analytics-list-item';
                li.innerHTML = `
                    <span class="analytics-list-name">${teacher.name}</span>
                    <span class="analytics-list-value">${teacher.spare.toFixed(1)}h spare</span>
                `;
                spareList.appendChild(li);
            });
            
            // Setup click handlers only once
            if (!staffClickHandlersInitialized) {
                setupStaffCardClickHandlers();
                staffClickHandlersInitialized = true;
            }
        }
        
        /**
         * Setup click handlers for staff summary cards
         */
        function setupStaffCardClickHandlers() {
            const popup = document.getElementById('staff-detail-popup');
            const titleEl = document.getElementById('staff-detail-title');
            const listEl = document.getElementById('staff-detail-list');
            const closeBtn = document.getElementById('staff-detail-close');
            
            if (!popup || !titleEl || !listEl || !closeBtn) {
                console.error('Staff detail popup elements not found');
                return;
            }
            
            // Close button handler
            closeBtn.onclick = () => {
                popup.classList.remove('active');
            };
            
            // Helper to show popup
            function showPopup(title, html) {
                titleEl.textContent = title;
                listEl.innerHTML = html;
                popup.classList.add('active');
            }
            
            // Teaching Staff card
            const teachingCard = document.getElementById('card-teaching-staff');
            if (teachingCard) {
                teachingCard.onclick = () => {
                    if (!currentAnalyticsData) return;
                    showPopup(
                        `üìö Teaching Staff (${currentAnalyticsData.teachingStaff.length})`,
                        currentAnalyticsData.teachingStaff
                            .sort()
                            .map(name => {
                                const hours = currentAnalyticsData.teacherHours.get(name) || 0;
                                return `<div class="analytics-detail-item">${name} <span style="color: #666; float: right;">${hours.toFixed(1)}h</span></div>`;
                            })
                            .join('')
                    );
                };
            }
            
            // Admin Staff card
            const adminCard = document.getElementById('card-admin-staff');
            if (adminCard) {
                adminCard.onclick = () => {
                    if (!currentAnalyticsData) return;
                    showPopup(
                        `üè¢ Admin Staff (${currentAnalyticsData.adminStaff.length})`,
                        currentAnalyticsData.adminStaff
                            .sort()
                            .map(name => `<div class="analytics-detail-item">${name}</div>`)
                            .join('')
                    );
                };
            }
            
            // Other Staff card
            const otherCard = document.getElementById('card-other-staff');
            if (otherCard) {
                otherCard.onclick = () => {
                    if (!currentAnalyticsData) return;
                    showPopup(
                        `üìã Other Staff (${currentAnalyticsData.otherStaff.length})`,
                        currentAnalyticsData.otherStaff
                            .sort()
                            .map(name => `<div class="analytics-detail-item">${name}</div>`)
                            .join('')
                    );
                };
            }
            
            // Under Capacity card
            const underCard = document.getElementById('card-under-capacity');
            if (underCard) {
                underCard.onclick = () => {
                    if (!currentAnalyticsData) return;
                    const underCapacity = Array.from(currentAnalyticsData.teacherHours.entries())
                        .filter(([name, hours]) => hours < HOUR_THRESHOLD_WARNING)
                        .sort((a, b) => a[1] - b[1]);
                    showPopup(
                        `‚úÖ Under 18 Hours (${underCapacity.length})`,
                        underCapacity
                            .map(([name, hours]) => {
                                const spare = HOUR_THRESHOLD_WARNING - hours;
                                return `<div class="analytics-detail-item">${name} <span style="color: #28a745; float: right;">${hours.toFixed(1)}h (${spare.toFixed(1)}h spare)</span></div>`;
                            })
                            .join('')
                    );
                };
            }
            
            // At Capacity card
            const atCapacityCard = document.getElementById('card-at-capacity');
            if (atCapacityCard) {
                atCapacityCard.onclick = () => {
                    if (!currentAnalyticsData) return;
                    const atCapacity = Array.from(currentAnalyticsData.teacherHours.entries())
                        .filter(([name, hours]) => hours >= HOUR_THRESHOLD_WARNING && hours < HOUR_THRESHOLD_DANGER)
                        .sort((a, b) => b[1] - a[1]);
                    showPopup(
                        `‚ö†Ô∏è At Capacity 18-20h (${atCapacity.length})`,
                        atCapacity.length > 0 
                            ? atCapacity.map(([name, hours]) => `<div class="analytics-detail-item">${name} <span style="color: #e6a700; float: right;">${hours.toFixed(1)}h</span></div>`).join('')
                            : '<div class="analytics-detail-item" style="color: #28a745;">‚úÖ No teachers in this range</div>'
                    );
                };
            }
            
            // Over Limit card
            const overCard = document.getElementById('card-over-limit');
            if (overCard) {
                overCard.onclick = () => {
                    if (!currentAnalyticsData) return;
                    const overLimit = Array.from(currentAnalyticsData.teacherHours.entries())
                        .filter(([name, hours]) => hours >= HOUR_THRESHOLD_DANGER)
                        .sort((a, b) => b[1] - a[1]);
                    showPopup(
                        `üö® Over Limit 20h+ (${overLimit.length})`,
                        overLimit.length > 0
                            ? overLimit.map(([name, hours]) => `<div class="analytics-detail-item">${name} <span style="color: #dc3545; float: right;">${hours.toFixed(1)}h</span></div>`).join('')
                            : '<div class="analytics-detail-item" style="color: #28a745;">‚úÖ No teachers over limit</div>'
                    );
                };
            }
            
            console.log('Staff card click handlers initialized');
        }

        /**
         * Update Subject Analysis section
         */
        function updateSubjectAnalysis(analytics) {
            const subjectData = analytics.subjectData;
            
            document.getElementById('stat-subject-count').textContent = subjectData.totalSubjects;
            document.getElementById('stat-single-teacher').textContent = subjectData.singleTeacherSubjects.length;
            
            // Update subject hours list
            const subjectList = document.getElementById('subject-hours-list');
            subjectList.innerHTML = '';
            
            subjectData.subjects.forEach(subject => {
                const li = document.createElement('li');
                li.className = 'analytics-list-item clickable';
                
                const isSingleTeacher = subject.teacherCount === 1;
                const valueClass = isSingleTeacher ? 'analytics-list-value warning' : 'analytics-list-value';
                const warningIcon = isSingleTeacher ? ' ‚ö†Ô∏è' : '';
                
                li.innerHTML = `
                    <span class="analytics-list-name">${subject.name}${warningIcon}</span>
                    <span class="${valueClass}">${subject.hours.toFixed(1)}h (${subject.teacherCount} teacher${subject.teacherCount !== 1 ? 's' : ''})</span>
                `;
                
                // Create inline detail element
                const detail = document.createElement('div');
                detail.className = 'analytics-inline-detail';
                detail.innerHTML = `<span class="analytics-inline-detail-label">Teachers:</span> ${subject.teachers.sort().join(', ')}`;
                
                // Toggle detail on click
                li.addEventListener('click', () => {
                    // Close any other open details
                    document.querySelectorAll('#subject-hours-list .analytics-inline-detail.active').forEach(el => {
                        if (el !== detail) el.classList.remove('active');
                    });
                    detail.classList.toggle('active');
                });
                
                subjectList.appendChild(li);
                subjectList.appendChild(detail);
            });
        }

        /**
         * Update Room Analysis section
         */
        function updateRoomAnalysis(analytics) {
            const roomData = analytics.roomData;
            
            document.getElementById('stat-room-count').textContent = roomData.totalRooms;
            
            if (roomData.busiestRoom) {
                document.getElementById('stat-busiest-room').textContent = roomData.busiestRoom.name;
                document.getElementById('stat-busiest-room-hours').textContent = 
                    `${roomData.busiestRoom.hours.toFixed(1)} hours`;
            } else {
                document.getElementById('stat-busiest-room').textContent = '-';
                document.getElementById('stat-busiest-room-hours').textContent = 'No data';
            }
            
            document.getElementById('stat-avg-room').innerHTML = 
                `${roomData.avgHoursPerRoom.toFixed(1)}<span class="stat-unit">hrs</span>`;
            
            // Update room usage list
            const roomList = document.getElementById('room-usage-list');
            roomList.innerHTML = '';
            
            roomData.rooms.slice(0, 50).forEach(room => {
                const li = document.createElement('li');
                li.className = 'analytics-list-item clickable';
                li.innerHTML = `
                    <span class="analytics-list-name">${room.name}</span>
                    <span class="analytics-list-value">${room.hours.toFixed(1)}h</span>
                `;
                
                // Create inline detail element
                const detail = document.createElement('div');
                detail.className = 'analytics-inline-detail';
                detail.innerHTML = `<span class="analytics-inline-detail-label">Subjects:</span> ${room.subjects.length > 0 ? room.subjects.join(', ') : 'No subjects recorded'}`;
                
                // Toggle detail on click
                li.addEventListener('click', () => {
                    // Close any other open details
                    document.querySelectorAll('#room-usage-list .analytics-inline-detail.active').forEach(el => {
                        if (el !== detail) el.classList.remove('active');
                    });
                    detail.classList.toggle('active');
                });
                
                roomList.appendChild(li);
                roomList.appendChild(detail);
            });
        }

        /**
         * Update Schedule Patterns section
         */
        let currentSchedulePatterns = null;
        let selectedDay = null; // null = all week
        
        function updateSchedulePatterns(analytics) {
            const patterns = analytics.schedulePatterns;
            currentSchedulePatterns = patterns;
            
            // Update day cards
            const dayGrid = document.getElementById('day-pattern-grid');
            dayGrid.innerHTML = '';
            
            const days = ['Mon', 'Tue', 'Wed', 'Thur', 'Fri'];
            days.forEach(day => {
                const count = patterns.dayLessons[day] || 0;
                const isBusiest = day === patterns.busiestDay?.name;
                const isQuietest = day === patterns.quietestDay?.name;
                const isSelected = day === selectedDay;
                
                const card = document.createElement('div');
                card.className = 'day-card' + 
                    (isBusiest ? ' busiest' : '') + 
                    (isQuietest ? ' quietest' : '') +
                    (isSelected ? ' selected' : '');
                card.style.cursor = 'pointer';
                
                if (isSelected) {
                    card.style.outline = '3px solid #003d82';
                    card.style.outlineOffset = '2px';
                }
                
                let label = '';
                if (isBusiest) label = 'üî• Busiest';
                else if (isQuietest) label = 'üòå Quietest';
                
                card.innerHTML = `
                    <div class="day-name">${day}</div>
                    <div class="day-lessons">${count}</div>
                    <div class="day-label">${label || 'lessons'}</div>
                `;
                
                // Click handler to filter peak hours by day
                card.addEventListener('click', () => {
                    if (selectedDay === day) {
                        // Clicking same day deselects - show all week
                        selectedDay = null;
                    } else {
                        selectedDay = day;
                    }
                    updateSchedulePatterns(analytics);
                });
                
                dayGrid.appendChild(card);
            });
            
            // Update label
            const labelEl = document.getElementById('peak-hours-label');
            if (labelEl) {
                labelEl.textContent = selectedDay ? `(${selectedDay} only)` : '(all week average)';
            }
            
            // Update peak hours bar
            const peakBar = document.getElementById('peak-hours-bar');
            peakBar.innerHTML = '';
            
            // Get the right data based on selection
            let hourData;
            let maxCount;
            let divisor = 1;
            
            if (selectedDay && patterns.hourBucketsByDay[selectedDay]) {
                hourData = patterns.hourBucketsByDay[selectedDay];
                maxCount = Math.max(...Object.values(hourData)) || 1;
            } else {
                hourData = patterns.hourBuckets;
                maxCount = patterns.maxHourCount || 1;
                divisor = 5; // Divide by 5 for weekly average
            }
            
            for (let h = 8; h <= 16; h++) {
                const totalCount = hourData[h] || 0;
                const displayCount = divisor > 1 ? Math.round(totalCount / divisor) : totalCount;
                const intensity = totalCount / maxCount;
                
                // Color based on intensity
                let color;
                if (intensity > 0.8) {
                    color = '#dc3545'; // Red - busiest
                } else if (intensity > 0.6) {
                    color = '#ffc107'; // Yellow
                } else if (intensity > 0.3) {
                    color = '#28a745'; // Green
                } else {
                    color = '#6c757d'; // Gray - quietest
                }
                
                const segment = document.createElement('div');
                segment.className = 'peak-hour-segment';
                segment.style.flex = '1';
                segment.style.background = color;
                segment.textContent = displayCount > 0 ? displayCount : '';
                
                if (selectedDay) {
                    segment.title = `${h}:00 - ${h+1}:00: ${totalCount} lessons on ${selectedDay}`;
                } else {
                    segment.title = `${h}:00 - ${h+1}:00: ~${displayCount} lessons/day (${totalCount} total/week)`;
                }
                
                peakBar.appendChild(segment);
            }
            
            // Update "Students Out of Class" bar
            const freeBar = document.getElementById('free-periods-bar');
            if (freeBar) {
                freeBar.innerHTML = '';
                
                const totalGroups = patterns.totalGroups || 1;
                const allGroups = patterns.allStudentGroups || new Set();
                const maxFree = totalGroups; // Max possible is all groups free
                
                // Setup close button for free classes detail
                const freeClassesClose = document.getElementById('free-classes-close');
                if (freeClassesClose) {
                    freeClassesClose.onclick = () => {
                        document.getElementById('free-classes-detail').classList.remove('active');
                    };
                }
                
                for (let h = 8; h <= 16; h++) {
                    let freeCount;
                    let inClassGroups;
                    
                    if (selectedDay && patterns.studentGroupsByHourByDay[selectedDay]) {
                        inClassGroups = patterns.studentGroupsByHourByDay[selectedDay][h] || new Set();
                        freeCount = totalGroups - inClassGroups.size;
                    } else {
                        // For all week, use the averaged data
                        inClassGroups = patterns.studentGroupsByHour[h] || new Set();
                        freeCount = patterns.freeStudentsByHour[h] || 0;
                    }
                    
                    // Calculate which groups are FREE (not in the inClass set)
                    const freeGroups = Array.from(allGroups).filter(g => !inClassGroups.has(g)).sort((a, b) => {
                        // Sort by year then class letter
                        const aNum = parseInt(a.match(/\d+/)?.[0] || '0');
                        const bNum = parseInt(b.match(/\d+/)?.[0] || '0');
                        if (aNum !== bNum) return aNum - bNum;
                        return a.localeCompare(b);
                    });
                    
                    const intensity = freeCount / maxFree;
                    
                    // Inverse colors - more free = red (need behavior support), fewer free = green
                    let color;
                    if (intensity > 0.7) {
                        color = '#dc3545'; // Red - most students free
                    } else if (intensity > 0.4) {
                        color = '#ffc107'; // Yellow
                    } else if (intensity > 0.1) {
                        color = '#28a745'; // Green
                    } else {
                        color = '#6c757d'; // Gray - almost all in class
                    }
                    
                    const segment = document.createElement('div');
                    segment.className = 'peak-hour-segment';
                    segment.style.flex = '1';
                    segment.style.background = color;
                    segment.style.cursor = 'pointer';
                    segment.textContent = freeCount > 0 ? freeCount : '';
                    
                    const dayLabel = selectedDay || 'all week';
                    segment.title = `${h}:00 - ${h+1}:00: Click to see which ${freeCount} classes are free`;
                    
                    // Store data for click handler
                    const hourVal = h;
                    const freeGroupsData = freeGroups;
                    const inClassGroupsData = Array.from(inClassGroups).sort();
                    
                    segment.addEventListener('click', () => {
                        const detailEl = document.getElementById('free-classes-detail');
                        const titleEl = document.getElementById('free-classes-title');
                        const listEl = document.getElementById('free-classes-list');
                        
                        const timeStr = `${hourVal}:00 - ${hourVal + 1}:00`;
                        const dayStr = selectedDay ? ` on ${selectedDay}` : ' (all week)';
                        
                        titleEl.textContent = `üö∂ Classes Free at ${timeStr}${dayStr}`;
                        
                        if (freeGroupsData.length === 0) {
                            listEl.innerHTML = '<div class="analytics-detail-item" style="color: #28a745;">‚úÖ All classes are in lessons at this time</div>';
                        } else {
                            // Group by year
                            const byYear = {};
                            freeGroupsData.forEach(g => {
                                const year = g.match(/\d+/)?.[0] || 'Other';
                                if (!byYear[year]) byYear[year] = [];
                                byYear[year].push(g);
                            });
                            
                            let html = '';
                            Object.keys(byYear).sort((a, b) => parseInt(a) - parseInt(b)).forEach(year => {
                                html += `<div class="analytics-detail-item"><strong>Year ${year}:</strong> ${byYear[year].join(', ')}</div>`;
                            });
                            
                            html += `<div class="analytics-detail-item" style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #e0e0e0; color: #666;">
                                <strong>In class:</strong> ${inClassGroupsData.length > 0 ? inClassGroupsData.join(', ') : 'None'}
                            </div>`;
                            
                            listEl.innerHTML = html;
                        }
                        
                        detailEl.classList.add('active');
                    });
                    
                    freeBar.appendChild(segment);
                }
            }
        }

        /**
         * Update Risk Analysis section
         */
        function updateRiskAnalysis(analytics) {
            const alertContainer = document.getElementById('risk-alerts-container');
            alertContainer.innerHTML = '';
            
            // Single-teacher subjects alert
            const singleTeacherSubjects = analytics.subjectData.singleTeacherSubjects;
            if (singleTeacherSubjects.length > 0) {
                const alert = document.createElement('div');
                alert.className = 'risk-alert' + (singleTeacherSubjects.length > 3 ? ' critical' : '');
                alert.innerHTML = `
                    <div class="risk-alert-icon">${singleTeacherSubjects.length > 3 ? 'üö®' : '‚ö†Ô∏è'}</div>
                    <div class="risk-alert-content">
                        <div class="risk-alert-title">Single Points of Failure</div>
                        <div class="risk-alert-text">
                            ${singleTeacherSubjects.length} subject${singleTeacherSubjects.length !== 1 ? 's have' : ' has'} only 1 qualified teacher: 
                            <strong>${singleTeacherSubjects.map(s => s.name).join(', ')}</strong>
                        </div>
                    </div>
                `;
                alertContainer.appendChild(alert);
            }
            
            // Teachers over limit alert
            if (analytics.teachersOverLimit > 0) {
                const alert = document.createElement('div');
                alert.className = 'risk-alert critical';
                alert.innerHTML = `
                    <div class="risk-alert-icon">üö®</div>
                    <div class="risk-alert-content">
                        <div class="risk-alert-title">Teachers Over Hour Limit</div>
                        <div class="risk-alert-text">
                            ${analytics.teachersOverLimit} teacher${analytics.teachersOverLimit !== 1 ? 's are' : ' is'} 
                            working over ${HOUR_THRESHOLD_DANGER} hours this week.
                        </div>
                    </div>
                `;
                alertContainer.appendChild(alert);
            }
            
            // High utilization alert
            if (analytics.capacityUtilization > 90) {
                const alert = document.createElement('div');
                alert.className = 'risk-alert' + (analytics.capacityUtilization > 95 ? ' critical' : '');
                alert.innerHTML = `
                    <div class="risk-alert-icon">${analytics.capacityUtilization > 95 ? 'üö®' : '‚ö†Ô∏è'}</div>
                    <div class="risk-alert-content">
                        <div class="risk-alert-title">High Capacity Utilization</div>
                        <div class="risk-alert-text">
                            School is at ${analytics.capacityUtilization.toFixed(1)}% capacity. 
                            Limited flexibility for cover assignments.
                        </div>
                    </div>
                `;
                alertContainer.appendChild(alert);
            }
            
            // No alerts message
            if (alertContainer.children.length === 0) {
                alertContainer.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #28a745;">
                        <div style="font-size: 2em; margin-bottom: 10px;">‚úÖ</div>
                        <p>No critical risks detected</p>
                    </div>
                `;
            }
            
            // Update at capacity list (renamed from burnout)
            const atCapacityList = document.getElementById('at-capacity-list');
            atCapacityList.innerHTML = '';
            
            // Get teachers at or over capacity
            const teachersAtCapacity = Array.from(analytics.teacherHours.entries())
                .filter(([name, hours]) => hours >= HOUR_THRESHOLD_WARNING)
                .map(([name, hours]) => ({ name, hours }))
                .sort((a, b) => b.hours - a.hours);
            
            if (teachersAtCapacity.length === 0) {
                const li = document.createElement('li');
                li.className = 'analytics-list-item';
                li.innerHTML = '<span class="analytics-list-name" style="color: #28a745;">‚úÖ No teachers at 18h+ this week</span>';
                atCapacityList.appendChild(li);
            } else {
                teachersAtCapacity.forEach(teacher => {
                    const li = document.createElement('li');
                    li.className = 'analytics-list-item';
                    const isOver = teacher.hours >= HOUR_THRESHOLD_DANGER;
                    li.innerHTML = `
                        <span class="analytics-list-name">${teacher.name}</span>
                        <span class="analytics-list-value ${isOver ? 'danger' : 'warning'}">${teacher.hours.toFixed(1)}h</span>
                    `;
                    atCapacityList.appendChild(li);
                });
            }
        }

        /**
         * Update Year Group Analysis section
         */
        function updateYearGroupAnalysis(analytics) {
            const groupData = analytics.yearGroupData;
            
            document.getElementById('stat-yeargroup-count').textContent = groupData.totalGroups;
            
            if (groupData.busiestGroup) {
                document.getElementById('stat-busiest-group').textContent = groupData.busiestGroup.name;
                document.getElementById('stat-busiest-group-hours').textContent = 
                    `${groupData.busiestGroup.hours.toFixed(1)} hours`;
            } else {
                document.getElementById('stat-busiest-group').textContent = '-';
                document.getElementById('stat-busiest-group-hours').textContent = 'No data';
            }
            
            // Setup close button for year group detail popup
            const closeBtn = document.getElementById('yeargroup-detail-close');
            if (closeBtn) {
                closeBtn.onclick = () => {
                    document.getElementById('yeargroup-detail-popup').classList.remove('active');
                };
            }
            
            // Update year group list
            const groupList = document.getElementById('yeargroup-hours-list');
            groupList.innerHTML = '';
            
            groupData.groups.forEach(group => {
                const li = document.createElement('li');
                li.className = 'analytics-list-item clickable';
                li.innerHTML = `
                    <span class="analytics-list-name">${group.name}</span>
                    <span class="analytics-list-value">${group.hours.toFixed(1)}h (${group.teacherCount} teachers)</span>
                `;
                
                // Click handler to show subject breakdown
                li.addEventListener('click', () => {
                    showYearGroupDetail(group);
                });
                
                groupList.appendChild(li);
            });
        }
        
        /**
         * Show detailed breakdown for a year group
         */
        function showYearGroupDetail(group) {
            const popup = document.getElementById('yeargroup-detail-popup');
            const titleEl = document.getElementById('yeargroup-detail-title');
            const listEl = document.getElementById('yeargroup-detail-list');
            
            titleEl.textContent = `üìö ${group.name} - Weekly Schedule Breakdown`;
            
            let html = `
                <div class="analytics-detail-item" style="background: #e3f2fd; margin-bottom: 15px;">
                    <strong>Total:</strong> ${group.hours.toFixed(1)} hours across ${group.subjects.length} subjects with ${group.teacherCount} teachers
                </div>
                <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                    <thead>
                        <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                            <th style="padding: 10px; text-align: left;">Subject</th>
                            <th style="padding: 10px; text-align: center;">Hours</th>
                            <th style="padding: 10px; text-align: center;">Lessons</th>
                            <th style="padding: 10px; text-align: left;">Teacher(s)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            group.subjects.forEach(subject => {
                html += `
                    <tr style="border-bottom: 1px solid #e0e0e0;">
                        <td style="padding: 8px;"><strong>${subject.name}</strong></td>
                        <td style="padding: 8px; text-align: center;">${subject.hours.toFixed(1)}h</td>
                        <td style="padding: 8px; text-align: center;">${subject.lessonCount}</td>
                        <td style="padding: 8px; color: #666;">${subject.teachers.join(', ')}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
                <div class="analytics-detail-item" style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #e0e0e0;">
                    <strong>All Teachers for ${group.name}:</strong><br>
                    <span style="color: #666;">${group.teachers.join(', ')}</span>
                </div>
            `;
            
            listEl.innerHTML = html;
            popup.classList.add('active');
        }

        /**
         * Display available staff list with duration (how long they're available)
         * @param {Array} staffList - List of available staff
         * @param {HTMLElement} listElement - UL element to populate
         * @param {Date} currentTime - Current time for calculations
         * @param {boolean} showAssignButton - Whether to show "Assign" button (teaching staff only)
         */
        function displayAvailableList(staffList, listElement, currentTime, showAssignButton = false) {
            listElement.innerHTML = '';

            if (staffList.length === 0) {
                return;
            }

            const nowMinutes = (currentTime.getHours() * 60) + currentTime.getMinutes();

            staffList.forEach(item => {
                const li = document.createElement('li');
                const teacher = item.teacher;
                const endTime = item.endTime;

                // Check if this teacher is excluded
                const isExcluded = excludedStaff.has(teacher);
                if (isExcluded && showExcludedMode) {
                    li.classList.add('excluded-staff');
                }

                // Calculate duration available
                let durationText = '';
                let endTimeStr = '';
                if (endTime) {
                    const durationMinutes = endTime - nowMinutes;
                    const durationHours = Math.floor(durationMinutes / 60);
                    const durationMins = durationMinutes % 60;
                    endTimeStr = minutesToHHMM(endTime);

                    if (durationHours > 0 && durationMins > 0) {
                        durationText = `${durationHours}h ${durationMins}m until ${endTimeStr}`;
                    } else if (durationHours > 0) {
                        durationText = `${durationHours}h until ${endTimeStr}`;
                    } else if (durationMins > 0) {
                        durationText = `${durationMins}m until ${endTimeStr}`;
                    } else {
                        durationText = `until ${endTimeStr}`;
                    }
                }

                // Build HTML with exclude/reinclude button
                let excludeButtonHtml = '';
                if (showExcludedMode) {
                    // Show green "add back" button
                    excludeButtonHtml = `<button class="exclude-btn reinclude-btn" data-teacher="${teacher}" title="Re-include this teacher">√ó</button>`;
                } else {
                    // Show red "exclude" button
                    excludeButtonHtml = `<button class="exclude-btn" data-teacher="${teacher}" title="Exclude this teacher">√ó</button>`;
                }

                // Optional Assign button (only for teaching staff in normal mode)
                let assignButtonHtml = '';
                if (showAssignButton && !showExcludedMode) {
                    assignButtonHtml = `<button class="assign-cover-btn" data-teacher="${teacher}" data-end-time="${endTimeStr}">Assign</button>`;
                }

                li.innerHTML = `
                    <span class="teacher-name">${teacher}</span>
                    ${durationText ? `<span class="teacher-duration">(${durationText})</span>` : ''}
                    ${excludeButtonHtml}
                    ${assignButtonHtml}
                `;

                // Add click handler for Exclude/Re-include button
                const excludeBtn = li.querySelector('.exclude-btn');
                if (excludeBtn) {
                    excludeBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                        console.log('[EXCLUSION] Button clicked for:', teacher);
                        toggleTeacherExclusion(teacher);
                    });
                }

                // Add click handler for Assign button
                if (showAssignButton && !showExcludedMode) {
                    const assignBtn = li.querySelector('.assign-cover-btn');
                    if (assignBtn) {
                        assignBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            openAssignCoverModal(teacher, endTimeStr);
                        });
                    }
                }

                listElement.appendChild(li);
            });
        }

        // ============================================================================
        // ASSIGN COVER MODAL
        // ============================================================================

        /**
         * Open the Assign Cover modal for a specific teacher
         */
        function openAssignCoverModal(teacherName, availableUntil) {
            currentModalTeacher = teacherName;
            
            // Set teacher name in modal
            document.getElementById('modal-teacher-name').textContent = `üë§ ${teacherName}`;
            
            // Set default date to today
            const today = new Date();
            document.getElementById('cover-date').valueAsDate = today;
            
            // Set default time from now
            const now = new Date();
            const currentTime = now.toTimeString().substring(0, 5);
            document.getElementById('cover-time-from').value = clampTimeToRange(currentTime);
            
            // Set default time to (either available until or +1 hour)
            if (availableUntil) {
                document.getElementById('cover-time-to').value = availableUntil;
            } else {
                const later = new Date(now.getTime() + 60 * 60 * 1000);
                const laterTime = later.toTimeString().substring(0, 5);
                document.getElementById('cover-time-to').value = clampTimeToRange(laterTime);
            }
            
            // Clear reason field
            document.getElementById('cover-reason').value = '';
            
            // Show modal
            document.getElementById('assign-cover-modal').classList.add('active');
            
            // Focus on reason field
            setTimeout(() => {
                document.getElementById('cover-reason').focus();
            }, 100);
        }

        /**
         * Close the Assign Cover modal
         */
        function closeAssignCoverModal() {
            document.getElementById('assign-cover-modal').classList.remove('active');
            currentModalTeacher = null;
        }

        /**
         * Save the cover assignment
         */
        function saveCoverAssignment() {
            const teacherName = currentModalTeacher;
            const date = document.getElementById('cover-date').value;
            const timeFrom = document.getElementById('cover-time-from').value;
            const timeTo = document.getElementById('cover-time-to').value;
            const reason = document.getElementById('cover-reason').value.trim();
            
            // Validation
            if (!teacherName) {
                alert('Error: No teacher selected');
                return;
            }
            
            if (!date) {
                alert('Please select a date');
                return;
            }
            
            if (!timeFrom || !timeTo) {
                alert('Please enter both start and end times');
                return;
            }
            
            if (timeFrom >= timeTo) {
                alert('End time must be after start time');
                return;
            }
            
            if (!reason) {
                alert('Please enter a class or reason for the cover');
                return;
            }
            
            // Create assignment object
            const assignment = {
                id: Date.now(), // Unique ID
                teacherName: teacherName,
                date: date,
                timeFrom: timeFrom,
                timeTo: timeTo,
                reason: reason,
                assignedAt: new Date().toISOString(),
                assignedBy: 'User' // Could be expanded later
            };
            
            // Add to assignments array
            coverAssignments.push(assignment);
            
            // Log for debugging
            console.log('[COVER] New assignment:', assignment);
            console.log('[COVER] Total assignments:', coverAssignments.length);
            
            // Update the badge count and table
            updateAssignmentsTable();
            
            // Close modal
            closeAssignCoverModal();
            
            // Show confirmation
            showNotification(`‚úÖ Cover assigned to ${teacherName}`);
        }

        /**
         * Show a temporary notification
         */
        function showNotification(message) {
            // Create notification element if it doesn't exist
            let notification = document.getElementById('notification');
            if (!notification) {
                notification = document.createElement('div');
                notification.id = 'notification';
                notification.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: #28a745;
                    color: white;
                    padding: 15px 25px;
                    border-radius: 10px;
                    font-weight: 600;
                    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                    z-index: 10001;
                    opacity: 0;
                    transition: opacity 0.3s ease;
                `;
                document.body.appendChild(notification);
            }
            
            notification.textContent = message;
            notification.style.opacity = '1';
            
            // Hide after 3 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
            }, 3000);
        }

        // Modal event listeners (set up after DOM is ready)
        document.getElementById('modal-close').addEventListener('click', closeAssignCoverModal);
        document.getElementById('modal-cancel').addEventListener('click', closeAssignCoverModal);
        document.getElementById('modal-save').addEventListener('click', saveCoverAssignment);
        
        // Close modal when clicking outside
        document.getElementById('assign-cover-modal').addEventListener('click', (e) => {
            if (e.target.id === 'assign-cover-modal') {
                closeAssignCoverModal();
            }
        });
        
        // Close modal with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('assign-cover-modal').classList.contains('active')) {
                closeAssignCoverModal();
            }
        });

        // ============================================================================
        // TAB NAVIGATION
        // ============================================================================

        /**
         * Switch between tabs
         */
        function switchTab(tabId) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.tab === tabId) {
                    btn.classList.add('active');
                }
            });
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');
            
            // If switching to assignments tab, refresh the table
            if (tabId === 'cover-assignments-view') {
                updateAssignmentsTable();
            }
        }

        // Tab button click handlers
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                switchTab(btn.dataset.tab);
            });
        });

        // ============================================================================
        // COVER ASSIGNMENTS MANAGEMENT
        // ============================================================================

        /**
         * Update the assignments table display
         */
        function updateAssignmentsTable() {
            const emptyState = document.getElementById('assignments-empty');
            const tableContainer = document.getElementById('assignments-table-container');
            const tableBody = document.getElementById('assignments-table-body');
            const footer = document.getElementById('assignments-footer');
            const totalText = document.getElementById('assignments-total');
            const badge = document.getElementById('assignment-count-badge');
            
            // Update badge count
            badge.textContent = coverAssignments.length;
            
            if (coverAssignments.length === 0) {
                emptyState.style.display = 'block';
                tableContainer.style.display = 'none';
                footer.style.display = 'none';
                return;
            }
            
            emptyState.style.display = 'none';
            tableContainer.style.display = 'block';
            footer.style.display = 'flex';
            
            // Update total count
            totalText.textContent = `${coverAssignments.length} assignment${coverAssignments.length !== 1 ? 's' : ''}`;
            
            // Build table rows
            tableBody.innerHTML = '';
            
            // Sort by date and time
            const sortedAssignments = [...coverAssignments].sort((a, b) => {
                const dateCompare = a.date.localeCompare(b.date);
                if (dateCompare !== 0) return dateCompare;
                return a.timeFrom.localeCompare(b.timeFrom);
            });
            
            sortedAssignments.forEach(assignment => {
                const tr = document.createElement('tr');
                
                // Format date nicely
                const dateObj = new Date(assignment.date + 'T00:00:00');
                const formattedDate = dateObj.toLocaleDateString('en-GB', { 
                    weekday: 'short', 
                    day: 'numeric', 
                    month: 'short' 
                });
                
                tr.innerHTML = `
                    <td><strong>${assignment.teacherName}</strong></td>
                    <td>${formattedDate}</td>
                    <td>${assignment.timeFrom} - ${assignment.timeTo}</td>
                    <td>${assignment.reason}</td>
                    <td><button class="btn-remove" data-id="${assignment.id}">Remove</button></td>
                `;
                
                // Add remove button handler
                const removeBtn = tr.querySelector('.btn-remove');
                removeBtn.addEventListener('click', () => {
                    removeAssignment(assignment.id);
                });
                
                tableBody.appendChild(tr);
            });
        }

        /**
         * Remove a single assignment
         */
        function removeAssignment(id) {
            const index = coverAssignments.findIndex(a => a.id === id);
            if (index !== -1) {
                const removed = coverAssignments.splice(index, 1)[0];
                console.log('[COVER] Removed assignment:', removed);
                updateAssignmentsTable();
                showNotification(`üóëÔ∏è Removed cover assignment for ${removed.teacherName}`);
            }
        }

        /**
         * Clear all assignments
         */
        function clearAllAssignments() {
            console.log('[DEBUG] clearAllAssignments called, count:', coverAssignments.length);
            
            if (coverAssignments.length === 0) {
                console.log('[DEBUG] No assignments to clear');
                return;
            }
            
            const confirmResult = confirm(`Are you sure you want to clear all ${coverAssignments.length} assignment(s)?`);
            console.log('[DEBUG] Confirm result:', confirmResult);
            
            if (confirmResult) {
                coverAssignments = [];
                updateAssignmentsTable();
                showNotification('üóëÔ∏è All assignments cleared');
                console.log('[DEBUG] Assignments cleared');
            }
        }

        /**
         * Export assignments to CSV
         */
        function exportAssignmentsCSV() {
            if (coverAssignments.length === 0) {
                alert('No assignments to export');
                return;
            }
            
            // CSV headers
            const headers = ['Teacher Name', 'Date', 'From', 'To', 'Class/Reason', 'Assigned At'];
            
            // Sort by date and time
            const sortedAssignments = [...coverAssignments].sort((a, b) => {
                const dateCompare = a.date.localeCompare(b.date);
                if (dateCompare !== 0) return dateCompare;
                return a.timeFrom.localeCompare(b.timeFrom);
            });
            
            // Build CSV rows
            const rows = sortedAssignments.map(a => {
                return [
                    a.teacherName,
                    a.date,
                    a.timeFrom,
                    a.timeTo,
                    `"${a.reason.replace(/"/g, '""')}"`, // Escape quotes in reason
                    a.assignedAt
                ].join(',');
            });
            
            // Combine headers and rows
            const csvContent = [headers.join(','), ...rows].join('\n');
            
            // Create download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            // Generate filename with date
            const today = new Date().toISOString().split('T')[0];
            const filename = `cover_assignments_${today}.csv`;
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification(`üì• Exported ${coverAssignments.length} assignment(s) to CSV`);
        }

        // Assignment action button handlers - with safety checks
        const clearAllBtn = document.getElementById('clear-all-assignments');
        const exportCsvBtn = document.getElementById('export-csv');
        
        if (clearAllBtn) {
            clearAllBtn.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('[DEBUG] Clear All clicked');
                clearAllAssignments();
            });
        } else {
            console.error('[ERROR] Clear All button not found');
        }
        
        if (exportCsvBtn) {
            exportCsvBtn.addEventListener('click', function(e) {
                e.preventDefault();
                exportAssignmentsCSV();
            });
        }

        // ============================================================================
        // TEACHER LIST AND SCHEDULE
        // ============================================================================

        /**
         * Gets all teachers from the data, separated into:
         * - teachingStaff: Staff with teaching hours this week (can be used for cover)
         * - otherStaff: Support staff OR non-admin staff with 0 teaching hours
         * - adminStaff: Admin staff
         */
        function getAllTeachersSeparated() {
            const teachersSet = new Set();
            const currentWeek = getCalendarWeek(new Date());
            
            lessons.forEach(lesson => {
                const teacherStr = lesson[columnMap['teacher']]?.trim();
                if (teacherStr) {
                    const teachers = parseTeachers(teacherStr);
                    teachers.forEach(t => {
                        if (t && t.length > 0) {
                            teachersSet.add(t);
                        }
                    });
                }
            });
            
            const teachingStaff = [];
            const otherStaff = [];
            const adminStaff = [];
            
            teachersSet.forEach(teacher => {
                // Skip completely excluded teachers (manual exclusions, MT if hidden)
                if (shouldExcludeCompletely(teacher)) {
                    return;
                }
                
                // Admin staff go to admin column
                if (isAdminStaff(teacher)) {
                    adminStaff.push(teacher);
                    return;
                }
                
                // Support staff go to "Other" column (can't be used for cover)
                if (isSupportStaff(teacher)) {
                    otherStaff.push(teacher);
                    return;
                }
                
                // Check if this teacher has teaching hours
                const weeklyHours = getWeeklyTeachingHours(teacher);
                const currentWeekHours = weeklyHours.get(currentWeek) || 0;
                
                // If they have teaching hours, they're teaching staff
                // Otherwise, they go to "Other"
                if (currentWeekHours > 0) {
                    teachingStaff.push(teacher);
                } else {
                    otherStaff.push(teacher);
                }
            });
            
            return {
                teachingStaff: teachingStaff.sort(),
                otherStaff: otherStaff.sort(),
                adminStaff: adminStaff.sort()
            };
        }

        /**
         * Gets only teaching staff (for availability calculations).
         * Excludes: Admin staff, MT teachers (if hidden), manual exclusions
         */
        function getAllTeachers() {
            const { teachingStaff } = getAllTeachersSeparated();
            return teachingStaff;
        }

        function getTeacherSchedule(teacherName, date) {
            const schedule = [];
            const checkWeekNum = getCalendarWeek(date);
            const checkDay = dayMap[date.getDay()];
            const seenLessons = new Set();

            lessons.forEach(lesson => {
                const lessonDay = lesson[columnMap['day']]?.trim();
                const weekString = lesson[columnMap['realweeks']];
                const subject = lesson[columnMap['subject']]?.trim();
                const startStr = lesson[columnMap['starttime']];
                const lenStr = lesson[columnMap['length']];
                const teacherStr = lesson[columnMap['teacher']]?.trim();
                const groupStr = (lesson[columnMap['group']] || '').trim();
                const roomStr = (lesson[columnMap['room']] || '').trim();

                if (!lessonDay || !weekString || !startStr || !lenStr || !teacherStr) return;

                const lessonWeeks = parseRealWeeks(weekString);
                if (lessonDay !== checkDay || !lessonWeeks.has(checkWeekNum)) return;

                const teachers = parseTeachers(teacherStr);
                if (teachers.includes(teacherName)) {
                    const lessonStart = timeToMinutes(startStr);
                    const lessonLength = parseInt(lenStr, 10);
                    if (isNaN(lessonLength) || lessonLength <= 0) return;
                    const lessonEnd = lessonStart + lessonLength;

                    const normalizedSubject = (subject || '').toLowerCase().trim();
                    const normalizedGroup = (groupStr || '').toLowerCase().trim();
                    const normalizedRoom = (roomStr || '').toLowerCase().trim();
                    const lessonKey = `${checkWeekNum}-${lessonDay}-${lessonStart}-${lessonEnd}-${normalizedSubject}-${normalizedGroup}-${normalizedRoom}`;
                    
                    if (!seenLessons.has(lessonKey)) {
                        seenLessons.add(lessonKey);
                        schedule.push({
                            start: lessonStart,
                            end: lessonEnd,
                            subject: subject,
                            group: groupStr,
                            room: roomStr,
                            length: lessonLength,
                            isArbetstid: subject.toLowerCase() === ARBETSTID_SUBJECT,
                            isLesson: isTeachingLesson(lesson)  // Use the strict version for display
                        });
                    }
                }
            });

            // Deduplication by time overlap
            const finalSchedule = [];
            schedule.forEach(item => {
                let hasOverlap = false;
                for (const existing of finalSchedule) {
                    if (item.start < existing.end && item.end > existing.start) {
                        hasOverlap = true;
                        const itemScore = (item.room ? 1 : 0) + (item.group ? 1 : 0) + (item.isLesson ? 1 : 0);
                        const existingScore = (existing.room ? 1 : 0) + (existing.group ? 1 : 0) + (existing.isLesson ? 1 : 0);
                        if (itemScore > existingScore) {
                            const index = finalSchedule.indexOf(existing);
                            finalSchedule[index] = item;
                        }
                        break;
                    }
                }
                if (!hasOverlap) {
                    finalSchedule.push(item);
                }
            });

            finalSchedule.sort((a, b) => {
                if (a.start !== b.start) return a.start - b.start;
                return (a.subject || '').localeCompare(b.subject || '');
            });
            
            return finalSchedule;
        }

        /**
         * Calculate weekly teaching hours using ONLY the teaching subjects whitelist.
         * 
         * IMPORTANT: Deduplicates by TIME SLOT, not by subject/group.
         * This is because the scheduling software often creates multiple entries
         * for the same time slot (e.g., Sv and Sva for the same class period).
         * A teacher can only teach ONE lesson at any given time.
         */
        function getWeeklyTeachingHours(teacherName) {
            const hoursByWeek = new Map();
            const seenTimeSlots = new Map(); // week -> Set of "day-startTime-duration" keys

            lessons.forEach(lesson => {
                // ONLY count if it's a teaching lesson (uses whitelist)
                if (!isTeachingLesson(lesson)) return;
                
                const weekString = lesson[columnMap['realweeks']];
                const lenStr = lesson[columnMap['length']];
                const teacherStr = lesson[columnMap['teacher']]?.trim();
                const lessonDay = lesson[columnMap['day']]?.trim();
                const startStr = lesson[columnMap['starttime']];

                if (!weekString || !lenStr || !teacherStr || !lessonDay || !startStr) return;

                const teachers = parseTeachers(teacherStr);
                if (!teachers.includes(teacherName)) return;

                const lessonLength = parseInt(lenStr, 10);
                if (isNaN(lessonLength) || lessonLength <= 0) return;

                // Create unique key for this TIME SLOT only
                // A teacher can only be in one place at a time!
                const lessonStart = timeToMinutes(startStr);
                const timeSlotKey = `${lessonDay}-${lessonStart}-${lessonLength}`;
                
                const lessonWeeks = parseRealWeeks(weekString);
                lessonWeeks.forEach(week => {
                    // Initialize tracking set for this week if needed
                    if (!seenTimeSlots.has(week)) {
                        seenTimeSlots.set(week, new Set());
                    }
                    
                    // Only count if we haven't seen this time slot this week
                    if (!seenTimeSlots.get(week).has(timeSlotKey)) {
                        seenTimeSlots.get(week).add(timeSlotKey);
                        const currentHours = hoursByWeek.get(week) || 0;
                        hoursByWeek.set(week, currentHours + (lessonLength / 60));
                    }
                });
            });

            return hoursByWeek;
        }

        function displayTeacherSchedule(teacherName, date) {
            const schedule = getTeacherSchedule(teacherName, date);
            const scheduleDisplay = document.getElementById('teacher-schedule-display');
            const scheduleContent = document.getElementById('teacher-schedule-content');
            const teacherNameEl = document.getElementById('selected-teacher-name');

            teacherNameEl.textContent = `${teacherName} - ${date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`;
            scheduleDisplay.classList.add('active');

            if (schedule.length === 0) {
                scheduleContent.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No schedule found for this day.</p>';
            } else {
                let html = '<div class="schedule-timeline">';
                schedule.forEach(item => {
                    const startTime = minutesToHHMM(item.start);
                    const endTime = minutesToHHMM(item.end);
                    const duration = Math.round(item.length / 60 * 10) / 10;
                    
                    let itemClass = 'schedule-item';
                    if (item.isArbetstid) {
                        itemClass += ' arbetstid';
                    } else if (item.isLesson) {
                        itemClass += ' lesson';
                    } else {
                        itemClass += ' non-lesson';
                    }
                    
                    html += `<div class="${itemClass}">`;
                    html += `<div class="schedule-time">${startTime} - ${endTime} (${duration}h)`;
                    if (item.isLesson && !item.isArbetstid) {
                        html += ` <span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.75em; margin-left: 5px;">LESSON</span>`;
                    }
                    html += `</div>`;
                    html += `<div class="schedule-subject">${item.subject}</div>`;
                    if (item.group) html += `<div class="schedule-group">Group: ${item.group}</div>`;
                    if (item.room) html += `<div class="schedule-group">Room: ${item.room}</div>`;
                    html += `</div>`;
                });
                html += '</div>';
                scheduleContent.innerHTML = html;
            }

            // Display weekly hours chart with threshold warnings
            const weeklyHours = getWeeklyTeachingHours(teacherName);
            const chartContent = document.getElementById('hours-chart-content');
            
            if (weeklyHours.size === 0) {
                chartContent.innerHTML = '<p style="color: #666; text-align: center;">No teaching hours data available.</p>';
            } else {
                const sortedWeeks = Array.from(weeklyHours.keys()).sort((a, b) => a - b);
                const maxHours = Math.max(...Array.from(weeklyHours.values()), HOUR_THRESHOLD_DANGER);
                
                let chartHtml = '';
                sortedWeeks.forEach(week => {
                    const hours = weeklyHours.get(week);
                    const percentage = maxHours > 0 ? (hours / maxHours) * 100 : 0;
                    
                    // Determine warning class based on thresholds
                    let barClass = 'hours-bar-fill';
                    if (hours >= HOUR_THRESHOLD_DANGER) {
                        barClass += ' danger';
                    } else if (hours >= HOUR_THRESHOLD_WARNING) {
                        barClass += ' warning';
                    }
                    
                    chartHtml += `<div class="hours-bar-container">`;
                    chartHtml += `<div class="hours-bar-label">`;
                    chartHtml += `<span>Week ${week}</span>`;
                    chartHtml += `<span><strong>${hours.toFixed(1)}h</strong>`;
                    if (hours >= HOUR_THRESHOLD_DANGER) {
                        chartHtml += ` ‚ö†Ô∏è Over ${HOUR_THRESHOLD_DANGER}h`;
                    } else if (hours >= HOUR_THRESHOLD_WARNING) {
                        chartHtml += ` ‚ö° Near limit`;
                    }
                    chartHtml += `</span>`;
                    chartHtml += `</div>`;
                    chartHtml += `<div class="hours-bar">`;
                    chartHtml += `<div class="${barClass}" style="width: ${percentage}%">${hours.toFixed(1)}h</div>`;
                    chartHtml += `</div>`;
                    chartHtml += `</div>`;
                });
                chartContent.innerHTML = chartHtml;
            }
        }

        function populateAllTeachersList() {
            const { teachingStaff, otherStaff, adminStaff } = getAllTeachersSeparated();
            const teachingListElement = document.getElementById('teaching-staff-list');
            const otherListElement = document.getElementById('other-staff-list');
            const adminListElement = document.getElementById('admin-staff-list');
            const currentWeek = getCalendarWeek(new Date());
            
            teachingListElement.innerHTML = '';
            otherListElement.innerHTML = '';
            adminListElement.innerHTML = '';

            // Helper function to create clickable list item with hours
            function createStaffItem(teacher, listElement, showHours = true) {
                const li = document.createElement('li');
                
                // Get weekly hours for this teacher
                let hoursDisplay = '';
                let hoursClass = '';
                
                if (showHours) {
                    const weeklyHours = getWeeklyTeachingHours(teacher);
                    const currentWeekHours = weeklyHours.get(currentWeek) || 0;
                    
                    if (currentWeekHours >= HOUR_THRESHOLD_DANGER) {
                        hoursClass = 'hours-danger';
                    } else if (currentWeekHours >= HOUR_THRESHOLD_WARNING) {
                        hoursClass = 'hours-warning';
                    }
                    
                    hoursDisplay = `<span class="staff-hours ${hoursClass}">${currentWeekHours.toFixed(1)}h</span>`;
                }
                
                li.innerHTML = `<span class="staff-name">${teacher}</span>${hoursDisplay}`;
                li.dataset.teacher = teacher;  // Store clean name for later retrieval
                li.addEventListener('click', () => {
                    // Remove active class from all three lists
                    teachingListElement.querySelectorAll('li').forEach(item => item.classList.remove('active'));
                    otherListElement.querySelectorAll('li').forEach(item => item.classList.remove('active'));
                    adminListElement.querySelectorAll('li').forEach(item => item.classList.remove('active'));
                    // Add active class to clicked item
                    li.classList.add('active');
                    const selectedDate = dateInput.valueAsDate || new Date();
                    displayTeacherSchedule(teacher, selectedDate);
                });
                listElement.appendChild(li);
            }

            // Populate teaching staff (left column) with hours
            teachingStaff.forEach(teacher => createStaffItem(teacher, teachingListElement, true));

            // Populate other staff (middle column) - show 0.0h
            otherStaff.forEach(teacher => createStaffItem(teacher, otherListElement, true));

            // Populate admin staff (right column) - no hours (they don't teach)
            adminStaff.forEach(teacher => createStaffItem(teacher, adminListElement, false));
            
            // Update column headers with counts
            const teachingHeader = document.querySelector('.column-header.teaching');
            const otherHeader = document.querySelector('.column-header.other');
            const adminHeader = document.querySelector('.column-header.admin');
            if (teachingHeader) teachingHeader.textContent = `üìö Teaching Staff (${teachingStaff.length})`;
            if (otherHeader) otherHeader.textContent = `üìã Other (${otherStaff.length})`;
            if (adminHeader) adminHeader.textContent = `üè¢ Admin Staff (${adminStaff.length})`;
        }

        // ============================================================================
        // EVENT LISTENERS
        // ============================================================================

        // Toggle listeners
        if (lessonsOnlyToggle) {
            lessonsOnlyToggle.addEventListener('change', (e) => {
                lessonsOnlyMode = e.target.checked;
                updateAvailableNow();
                
                if (resultsContainer.style.display === 'block') {
                    checkButton.click();
                }
                
                // Check all three lists for active teacher
                const activeTeacher = document.querySelector('#teaching-staff-list li.active') || 
                                     document.querySelector('#other-staff-list li.active') ||
                                     document.querySelector('#admin-staff-list li.active');
                if (activeTeacher) {
                    const teacherName = activeTeacher.dataset.teacher || activeTeacher.textContent;
                    const selectedDate = dateInput.valueAsDate || new Date();
                    displayTeacherSchedule(teacherName, selectedDate);
                }
            });
        }

        if (hideMotherTongueToggle) {
            hideMotherTongueToggle.addEventListener('change', (e) => {
                showMotherTongueTeachers = !e.target.checked;
                populateAllTeachersList();
                updateAvailableNow();
                updateRecommendedForCover();
                
                if (resultsContainer.style.display === 'block') {
                    checkButton.click();
                }
            });
        }

        // Show All Week toggle for Recommended for Cover
        const showAllWeekToggle = document.getElementById('show-all-week-toggle');
        if (showAllWeekToggle) {
            showAllWeekToggle.addEventListener('change', (e) => {
                showAllWeekRecommendations = e.target.checked;
                updateRecommendedForCover();
            });
        }

        // Include Other Staff toggle for Recommended for Cover
        const includeOtherStaffToggle = document.getElementById('include-other-staff-toggle');
        if (includeOtherStaffToggle) {
            includeOtherStaffToggle.addEventListener('change', (e) => {
                includeOtherStaffInRecommendations = e.target.checked;
                updateRecommendedForCover();
            });
        }

        // Show Excluded toggle
        const showExcludedToggle = document.getElementById('show-excluded-toggle');
        if (showExcludedToggle) {
            showExcludedToggle.addEventListener('change', (e) => {
                showExcludedMode = e.target.checked;
                console.log('[EXCLUSION] Show excluded mode:', showExcludedMode);
                updateAvailableNow();

                // Update toggle label dynamically
                const label = showExcludedToggle.parentElement.querySelector('span');
                if (label) {
                    if (showExcludedMode) {
                        label.innerHTML = `Showing Excluded <span class="exclusion-count" id="exclusion-count-badge">${excludedStaff.size}</span>`;
                    } else {
                        label.innerHTML = `Show Excluded <span class="exclusion-count" id="exclusion-count-badge">${excludedStaff.size}</span>`;
                    }
                }
            });
        }

        // Include Excluded in Analytics toggle
        const includeExcludedAnalyticsToggle = document.getElementById('include-excluded-analytics-toggle');
        if (includeExcludedAnalyticsToggle) {
            includeExcludedAnalyticsToggle.addEventListener('change', (e) => {
                includeExcludedInAnalytics = e.target.checked;
                console.log('[EXCLUSION] Include excluded in analytics:', includeExcludedInAnalytics);
                // Refresh analytics to reflect the change
                updateAnalytics();
            });
        }

        // File input handler
        const fileInput = document.getElementById('schedule-file-input');
        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                loadData(event.target.result);
            };
            reader.onerror = () => {
                statusNow.textContent = 'Error reading file. Please try again.';
                statusNow.classList.add('error');
            };
            reader.readAsText(file);
        });

        // Date input change listener
        dateInput.addEventListener('change', () => {
            // Check all three lists for active teacher
            const activeTeacher = document.querySelector('#teaching-staff-list li.active') || 
                                 document.querySelector('#other-staff-list li.active') ||
                                 document.querySelector('#admin-staff-list li.active');
            if (activeTeacher) {
                const teacherName = activeTeacher.dataset.teacher || activeTeacher.textContent;
                const selectedDate = dateInput.valueAsDate || new Date();
                displayTeacherSchedule(teacherName, selectedDate);
            }
        });

        // Close schedule button
        const closeScheduleBtn = document.getElementById('close-schedule');
        if (closeScheduleBtn) {
            closeScheduleBtn.addEventListener('click', () => {
                document.getElementById('teacher-schedule-display').classList.remove('active');
                // Remove active from all three lists
                document.querySelectorAll('#teaching-staff-list li').forEach(li => li.classList.remove('active'));
                document.querySelectorAll('#other-staff-list li').forEach(li => li.classList.remove('active'));
                document.querySelectorAll('#admin-staff-list li').forEach(li => li.classList.remove('active'));
            });
        }

        // Check availability button
        checkButton.addEventListener('click', () => {
            const dateVal = dateInput.value;
            const timeFromVal = timeFromInput.value;
            const timeToVal = timeToInput.value;

            teachersCustomList.innerHTML = '';
            statusCustom.classList.remove('error');

            if (!dateVal || !timeFromVal || !timeToVal) {
                statusCustom.textContent = 'Please select date and times';
                statusCustom.classList.add('error');
                resultsContainer.style.display = 'block';
                return;
            }

            if (!validateTime(timeFromVal) || !validateTime(timeToVal)) {
                statusCustom.textContent = 'Times must be between 08:00 and 18:00';
                statusCustom.classList.add('error');
                resultsContainer.style.display = 'block';
                return;
            }

            const startMinutes = timeToMinutes(timeFromVal);
            const endMinutes = timeToMinutes(timeToVal);

            if (endMinutes <= startMinutes) {
                statusCustom.textContent = '"To" time must be after "From" time';
                statusCustom.classList.add('error');
                resultsContainer.style.display = 'block';
                return;
            }

            const [year, month, day] = dateVal.split('-').map(Number);
            const checkDate = new Date(year, month - 1, day);
            const checkDateTime = new Date(year, month - 1, day);
            checkDateTime.setHours(Math.floor(startMinutes / 60), startMinutes % 60, 0, 0);

            const { available } = getAvailabilityForRange(checkDate, startMinutes, endMinutes);
            resultsContainer.style.display = 'block';
            displayResults(available, teachersCustomList, statusCustom, checkDateTime);
        });

        // ============================================================================
        // MATRIX MODE (Easter Egg)
        // ============================================================================

        const matrixCanvas = document.getElementById('matrix-canvas');
        const matrixCtx = matrixCanvas.getContext('2d');
        const matrixToggle = document.getElementById('matrix-toggle');
        let matrixActive = false;
        let matrixAnimationId = null;

        function resizeMatrixCanvas() {
            matrixCanvas.width = window.innerWidth;
            matrixCanvas.height = window.innerHeight;
        }

        resizeMatrixCanvas();
        window.addEventListener('resize', resizeMatrixCanvas);

        const matrixChars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789@#$%^&*()_+-=[]{}|;:,.<>?„Ç¢„Ç§„Ç¶„Ç®„Ç™„Ç´„Ç≠„ÇØ„Ç±„Ç≥„Çµ„Ç∑„Çπ„Çª„ÇΩ„Çø„ÉÅ„ÉÑ„ÉÜ„Éà„Éä„Éã„Éå„Éç„Éé„Éè„Éí„Éï„Éò„Éõ„Éû„Éü„É†„É°„É¢„É§„É¶„É®„É©„É™„É´„É¨„É≠„ÉØ„É≤„É≥';
        const matrixCharArray = matrixChars.split('');

        const matrixFontSize = 14;
        let matrixColumns = Math.floor(matrixCanvas.width / matrixFontSize);
        const matrixDrops = [];
        
        function initMatrixDrops() {
            matrixColumns = Math.floor(matrixCanvas.width / matrixFontSize);
            matrixDrops.length = 0;
            for (let i = 0; i < matrixColumns; i++) {
                matrixDrops[i] = Math.random() * -100;
            }
        }

        initMatrixDrops();

        function drawMatrix() {
            if (!matrixActive) return;

            matrixCtx.fillStyle = 'rgba(0, 0, 0, 0.05)';
            matrixCtx.fillRect(0, 0, matrixCanvas.width, matrixCanvas.height);

            matrixCtx.fillStyle = '#00ff00';
            matrixCtx.font = matrixFontSize + 'px monospace';

            for (let i = 0; i < matrixDrops.length; i++) {
                const text = matrixCharArray[Math.floor(Math.random() * matrixCharArray.length)];
                const x = i * matrixFontSize;
                const y = matrixDrops[i] * matrixFontSize;

                const opacity = Math.random() > 0.95 ? 1 : 0.6;
                matrixCtx.fillStyle = `rgba(0, 255, 0, ${opacity})`;
                matrixCtx.fillText(text, x, y);

                if (y > matrixCanvas.height && Math.random() > 0.975) {
                    matrixDrops[i] = 0;
                }

                matrixDrops[i]++;
            }

            matrixAnimationId = requestAnimationFrame(drawMatrix);
        }

        const matrixWarningModal = document.getElementById('matrix-warning-modal');
        const matrixWarningConfirm = document.getElementById('matrix-warning-confirm');

        function activateMatrixMode() {
            matrixActive = true;
            matrixCanvas.classList.add('active');
            document.body.classList.add('matrix-mode');
            matrixToggle.textContent = 'X';
            matrixToggle.classList.add('active');
            resizeMatrixCanvas();
            initMatrixDrops();
            drawMatrix();
            matrixWarningModal.classList.remove('active');
        }

        function deactivateMatrixMode() {
            matrixActive = false;
            matrixCanvas.classList.remove('active');
            document.body.classList.remove('matrix-mode');
            matrixToggle.textContent = 'N';
            matrixToggle.classList.remove('active');
            if (matrixAnimationId) {
                cancelAnimationFrame(matrixAnimationId);
            }
            matrixCtx.clearRect(0, 0, matrixCanvas.width, matrixCanvas.height);
        }

        matrixToggle.addEventListener('click', () => {
            if (!matrixActive) {
                matrixWarningModal.classList.add('active');
            } else {
                deactivateMatrixMode();
            }
        });

        matrixWarningConfirm.addEventListener('click', () => {
            activateMatrixMode();
        });

        matrixWarningModal.addEventListener('click', (e) => {
            if (e.target === matrixWarningModal) {
                matrixWarningModal.classList.remove('active');
            }
        });

        // Initialize feedback button
        const feedbackButton = document.getElementById('feedback-button');
        if (feedbackButton) {
            if (FEEDBACK_FORM_URL !== "YOUR_GOOGLE_FORM_LINK_HERE") {
                feedbackButton.href = FEEDBACK_FORM_URL;
            } else {
                feedbackButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    alert('Feedback form link not configured. Please contact the administrator.');
                });
            }
        }

        // Load excluded staff from localStorage
        loadExcludedStaff();

        // Initialize - try to load automatically
        loadData().catch(() => {
            // If fetch fails, user will need to use file input
        });
    </script>
</body>
</html>
